<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1A1410">
<title>The Cafausica Brew Guide</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<meta name="apple-mobile-web-app-title" content="Cafausica">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{background:#1A1410;font-family:'DM Sans','Helvetica Neue',sans-serif;overflow-x:hidden}
button{cursor:pointer;font-family:inherit;border:none;background:none;transition:opacity 0.15s,transform 0.1s}
button:active{transform:scale(0.97);opacity:0.85}
textarea{font-family:inherit}
::-webkit-scrollbar{display:none}
</style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script>
const e=React.createElement,{useState,useEffect,useRef,useCallback}=React;

// ===== SVG ICONS (plain JS) =====
const svgIcon=(path,size=20,color="#F2EBE3",sw=2)=>e("svg",{width:size,height:size,viewBox:"0 0 24 24",fill:"none",stroke:color,strokeWidth:sw,strokeLinecap:"round",strokeLinejoin:"round"},e("path",{d:path}));
const ICO={
  back:(s,c)=>e("span",{style:{fontSize:(s||28)+"px",color:c||"#C0392B",fontWeight:900,lineHeight:1,display:"inline-block"}},"\u2190"),
  play:(s,c)=>svgIcon("M5 3l14 9-14 9V3z",s,c),
  pause:(s,c)=>e("svg",{width:s,height:s,viewBox:"0 0 24 24",fill:"none",stroke:c||"#F2EBE3",strokeWidth:2,strokeLinecap:"round"},e("path",{d:"M6 4h4v16H6zM14 4h4v16h-4z"})),
  skip:s=>svgIcon("M5 4l10 8-10 8V4zM19 5v14",s),
  star:(s,fill,color)=>e("svg",{width:s,height:s,viewBox:"0 0 24 24",fill:fill,stroke:color,strokeWidth:2},e("path",{d:"M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"})),
  history:s=>svgIcon("M12 8v4l3 3M3.05 11a9 9 0 1 1 .5 4m-.5 5v-5h5",s),
  plus:s=>svgIcon("M12 5v14M5 12h14",s),
  minus:s=>svgIcon("M5 12h14",s),
  check:s=>svgIcon("M20 6L9 17l-5-5",s),
  x:(s,c)=>svgIcon("M18 6L6 18M6 6l12 12",s,c),
  trash:s=>svgIcon("M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",s),
  right:s=>svgIcon("M9 18l6-6-6-6",s),
};

// ===== SVG ILLUSTRATIONS =====
const mkSvg=(sz,children)=>e("svg",{width:sz,height:sz,viewBox:"0 0 100 100",fill:"none"},children);
const Illust={
  v60:(sz=64)=>mkSvg(sz,[
    e("path",{key:0,d:"M72 40c8-2 14 2 14 10s-6 14-14 12",stroke:"#8B6B4A",strokeWidth:3,fill:"none"}),
    e("path",{key:1,d:"M22 20 L40 78 H60 L78 20",fill:"#F5F0EB",stroke:"#C4B5A3",strokeWidth:2.5}),
    e("ellipse",{key:2,cx:50,cy:20,rx:28,ry:6,fill:"#F8F4F0",stroke:"#C4B5A3",strokeWidth:2.5}),
    e("path",{key:3,d:"M30 28c6 12 10 28 14 46",stroke:"#D4C4B0",strokeWidth:1.2,fill:"none"}),
    e("path",{key:4,d:"M42 22c4 16 6 32 6 52",stroke:"#D4C4B0",strokeWidth:1,fill:"none"}),
    e("path",{key:5,d:"M58 22c-4 16-6 32-6 52",stroke:"#D4C4B0",strokeWidth:1,fill:"none"}),
    e("path",{key:6,d:"M70 28c-6 12-10 28-14 46",stroke:"#D4C4B0",strokeWidth:1.2,fill:"none"}),
    e("ellipse",{key:7,cx:50,cy:78,rx:10,ry:3,fill:"#E8DDD0",stroke:"#C4B5A3",strokeWidth:1.5}),
    e("ellipse",{key:8,cx:50,cy:36,rx:18,ry:4,fill:"#6B4226",opacity:0.2}),
    e("path",{key:9,d:"M34 90h32",stroke:"#C4B5A3",strokeWidth:2,strokeLinecap:"round"}),
  ]),
  aeropress:(sz=64)=>mkSvg(sz,[
    e("rect",{key:0,x:46,y:4,width:8,height:16,rx:2,fill:"#4A4A4A",stroke:"#333",strokeWidth:1.5}),
    e("circle",{key:1,cx:50,cy:6,r:6,fill:"#555",stroke:"#333",strokeWidth:1.5}),
    e("rect",{key:2,x:33,y:20,width:34,height:6,rx:3,fill:"#2A2A2A",stroke:"#333",strokeWidth:1.5}),
    e("rect",{key:3,x:30,y:22,width:40,height:52,rx:2,fill:"#6B6B6B",opacity:0.15,stroke:"#555",strokeWidth:2.5}),
    e("text",{key:4,x:34,y:38,fill:"#777",fontSize:7,fontWeight:700,fontFamily:"sans-serif"},"4"),
    e("text",{key:5,x:34,y:48,fill:"#777",fontSize:7,fontWeight:700,fontFamily:"sans-serif"},"3"),
    e("text",{key:6,x:34,y:58,fill:"#777",fontSize:7,fontWeight:700,fontFamily:"sans-serif"},"2"),
    e("text",{key:7,x:34,y:68,fill:"#777",fontSize:7,fontWeight:700,fontFamily:"sans-serif"},"1"),
    e("rect",{key:8,x:28,y:74,width:44,height:6,rx:3,fill:"#555",stroke:"#444",strokeWidth:2}),
    e("path",{key:9,d:"M36 92h28",stroke:"#999",strokeWidth:1.5,strokeLinecap:"round"}),
  ]),
  chemex:(sz=64)=>mkSvg(sz,[
    e("path",{key:0,d:"M28 10 L42 44 H58 L72 10",fill:"#F8F4F0",stroke:"#C4B5A3",strokeWidth:2,opacity:0.6}),
    e("ellipse",{key:1,cx:50,cy:10,rx:22,ry:4,fill:"none",stroke:"#C4B5A3",strokeWidth:2}),
    e("path",{key:2,d:"M28 10c-4-2-6 0-6 4",stroke:"#C4B5A3",strokeWidth:2,fill:"none"}),
    e("path",{key:3,d:"M42 44 L30 82 Q30 90 38 92 H62 Q70 90 70 82 L58 44",fill:"#E8F0E8",opacity:0.15,stroke:"#B8C8B0",strokeWidth:2}),
    e("rect",{key:4,x:40,y:38,width:20,height:16,rx:2,fill:"#B87A50",opacity:0.6,stroke:"#8B5E3C",strokeWidth:1.5}),
    e("path",{key:5,d:"M44 46c-6 1-6 6 0 6",stroke:"#654321",strokeWidth:2,fill:"none"}),
    e("path",{key:6,d:"M56 46c6 1 6 6 0 6",stroke:"#654321",strokeWidth:2,fill:"none"}),
    e("circle",{key:7,cx:44,cy:49,r:1.5,fill:"#654321"}),
    e("ellipse",{key:8,cx:50,cy:70,rx:12,ry:3,fill:"#6B4226",opacity:0.15}),
  ]),
  frenchpress:(sz=64)=>mkSvg(sz,[
    e("rect",{key:0,x:26,y:22,width:48,height:60,rx:3,fill:"none",stroke:"#888",strokeWidth:2.5}),
    e("rect",{key:1,x:29,y:24,width:42,height:56,rx:2,fill:"#D4A574",opacity:0.1,stroke:"#BBB",strokeWidth:1}),
    e("line",{key:2,x1:50,y1:6,x2:50,y2:22,stroke:"#999",strokeWidth:3}),
    e("circle",{key:3,cx:50,cy:6,r:5,fill:"#AAA",stroke:"#888",strokeWidth:1.5}),
    e("rect",{key:4,x:28,y:20,width:44,height:6,rx:3,fill:"#999",opacity:0.3,stroke:"#888",strokeWidth:1.5}),
    e("line",{key:5,x1:30,y1:42,x2:70,y2:42,stroke:"#AAA",strokeWidth:1.5,strokeDasharray:"3 2"}),
    e("path",{key:6,d:"M74 30c8 0 10 8 10 16s-2 16-10 16",stroke:"#888",strokeWidth:3,fill:"none"}),
    e("rect",{key:7,x:30,y:44,width:40,height:34,rx:1,fill:"#6B4226",opacity:0.12}),
    e("rect",{key:8,x:24,y:82,width:52,height:5,rx:2.5,fill:"#999",opacity:0.3,stroke:"#888",strokeWidth:1.5}),
  ]),
  cuccumella:(sz=64)=>mkSvg(sz,[
    // Parte superiore (caldaia) - cilindro con coperchio
    e("rect",{key:0,x:30,y:6,width:40,height:36,rx:3,fill:"none",stroke:"#A0785E",strokeWidth:2.5}),
    e("line",{key:1,x1:30,y1:12,x2:70,y2:12,stroke:"#A0785E",strokeWidth:1.5,opacity:0.4}),
    // Coperchio tondo
    e("ellipse",{key:2,cx:50,cy:6,rx:20,ry:3,fill:"#C4A882",opacity:0.15,stroke:"#A0785E",strokeWidth:2}),
    // Pomello coperchio
    e("circle",{key:3,cx:50,cy:3,r:2.5,fill:"#8B6543",stroke:"#A0785E",strokeWidth:1.5}),
    // Fascia filtro centrale
    e("rect",{key:4,x:28,y:42,width:44,height:8,rx:1,fill:"#8B6543",opacity:0.2,stroke:"#A0785E",strokeWidth:2}),
    // Forellini filtro
    e("circle",{key:5,cx:38,cy:46,r:1,fill:"#A0785E",opacity:0.5}),
    e("circle",{key:6,cx:44,cy:46,r:1,fill:"#A0785E",opacity:0.5}),
    e("circle",{key:7,cx:50,cy:46,r:1,fill:"#A0785E",opacity:0.5}),
    e("circle",{key:8,cx:56,cy:46,r:1,fill:"#A0785E",opacity:0.5}),
    e("circle",{key:9,cx:62,cy:46,r:1,fill:"#A0785E",opacity:0.5}),
    // Parte inferiore (raccoglitore) - cilindro
    e("rect",{key:10,x:30,y:50,width:40,height:36,rx:3,fill:"none",stroke:"#A0785E",strokeWidth:2.5}),
    // Beccuccio laterale (tipico della cuccumella ‚Äî sporge dal raccoglitore inferiore)
    e("path",{key:11,d:"M30 62 L22 58 L22 66 Z",fill:"#C4A882",opacity:0.3,stroke:"#A0785E",strokeWidth:2}),
    e("path",{key:12,d:"M22 58 L18 56",stroke:"#A0785E",strokeWidth:2,strokeLinecap:"round"}),
    // Manico destro (caldaia superiore)
    e("path",{key:13,d:"M70 18c6-1 9 4 9 10s-3 11-9 10",stroke:"#A0785E",strokeWidth:2.5,fill:"none"}),
    // Manico sinistro (raccoglitore inferiore)
    e("path",{key:14,d:"M30 62c-8-1-11 6-11 12s3 13 11 12",stroke:"#A0785E",strokeWidth:2.5,fill:"none"}),
    // Base
    e("line",{key:15,x1:28,y1:86,x2:72,y2:86,stroke:"#A0785E",strokeWidth:2,strokeLinecap:"round"}),
  ]),
  moka:(sz=64)=>mkSvg(sz,[
    // Caldaia inferiore (ottagonale Bialetti) ‚Äî base larga
    e("polygon",{key:0,points:"26,82 22,72 22,58 26,54 74,54 78,58 78,72 74,82",fill:"#D0D0D0",opacity:0.15,stroke:"#888",strokeWidth:2.5,strokeLinejoin:"round"}),
    // Sfaccettature verticali caldaia
    e("line",{key:1,x1:34,y1:54,x2:32,y2:82,stroke:"#AAA",strokeWidth:0.7,opacity:0.35}),
    e("line",{key:2,x1:50,y1:54,x2:50,y2:82,stroke:"#AAA",strokeWidth:0.7,opacity:0.35}),
    e("line",{key:3,x1:66,y1:54,x2:68,y2:82,stroke:"#AAA",strokeWidth:0.7,opacity:0.35}),
    // Fascia vita (giunto avvitabile)
    e("rect",{key:4,x:24,y:50,width:52,height:7,rx:1.5,fill:"#BBB",opacity:0.25,stroke:"#888",strokeWidth:2}),
    // Bricco superiore (ottagonale, pi√π stretto)
    e("polygon",{key:5,points:"32,50 30,44 30,30 34,22 66,22 70,30 70,44 68,50",fill:"#D0D0D0",opacity:0.1,stroke:"#888",strokeWidth:2.5,strokeLinejoin:"round"}),
    // Sfaccettature bricco
    e("line",{key:6,x1:40,y1:50,x2:38,y2:22,stroke:"#AAA",strokeWidth:0.6,opacity:0.3}),
    e("line",{key:7,x1:60,y1:50,x2:62,y2:22,stroke:"#AAA",strokeWidth:0.6,opacity:0.3}),
    // Coperchio con cerniera
    e("path",{key:8,d:"M34 22 Q36 16 50 14 Q64 16 66 22",fill:"#D0D0D0",opacity:0.15,stroke:"#888",strokeWidth:2}),
    // Pomello tondo nero (tipico Bialetti)
    e("circle",{key:9,cx:50,cy:12,r:4.5,fill:"#222",stroke:"#444",strokeWidth:1.5}),
    e("circle",{key:10,cx:50,cy:12,r:2,fill:"#444",opacity:0.4}),
    // Manico nero robusto (a C, plastica nera Bialetti)
    e("path",{key:11,d:"M78 56c8-2 12 6 12 14s-4 18-12 16",stroke:"#222",strokeWidth:5,fill:"none",strokeLinecap:"round"}),
    e("path",{key:12,d:"M78 56c8-2 12 6 12 14s-4 18-12 16",stroke:"#444",strokeWidth:3,fill:"none",strokeLinecap:"round"}),
    // Beccuccio
    e("path",{key:13,d:"M30 30 L24 26 L24 34 Z",fill:"#D0D0D0",opacity:0.3,stroke:"#888",strokeWidth:1.5}),
    // Base
    e("line",{key:14,x1:24,y1:84,x2:76,y2:84,stroke:"#888",strokeWidth:2,strokeLinecap:"round"}),
  ]),
  ibrik:(sz=64)=>mkSvg(sz,[
    e("path",{key:0,d:"M28 72 Q22 72 20 64 Q18 50 30 42 L36 32 Q38 28 44 26 H56 Q62 28 64 32 L70 42 Q82 50 80 64 Q78 72 72 72 Z",fill:"#CD7F32",opacity:0.2}),
    e("path",{key:1,d:"M28 72 Q22 72 20 64 Q18 50 30 42 L36 32 Q38 28 44 26 H56 Q62 28 64 32 L70 42 Q82 50 80 64 Q78 72 72 72 Z",fill:"none",stroke:"#B8860B",strokeWidth:2.5}),
    e("path",{key:2,d:"M44 26 Q46 22 50 20 Q54 22 56 26",stroke:"#B8860B",strokeWidth:2,fill:"#CD7F32",opacity:0.15}),
    e("path",{key:3,d:"M44 20c-2-2-4-2-6 0",stroke:"#B8860B",strokeWidth:2,strokeLinecap:"round"}),
    e("path",{key:4,d:"M38 28 L14 8",stroke:"#654321",strokeWidth:4,strokeLinecap:"round"}),
    e("path",{key:5,d:"M38 28 L14 8",stroke:"#8B5A2B",strokeWidth:2.5,strokeLinecap:"round"}),
    e("circle",{key:6,cx:14,cy:8,r:3,fill:"#654321",stroke:"#8B5A2B",strokeWidth:1}),
    e("path",{key:7,d:"M32 50h36",stroke:"#DAA520",strokeWidth:1.5,opacity:0.4}),
    e("ellipse",{key:8,cx:50,cy:24,rx:6,ry:2,fill:"#6B4226",opacity:0.2}),
    e("path",{key:9,d:"M28 72h44",stroke:"#B8860B",strokeWidth:2,strokeLinecap:"round"}),
  ]),
  jebena:(sz=64)=>mkSvg(sz,[
    e("ellipse",{key:0,cx:50,cy:66,rx:24,ry:20,fill:"#A0522D",opacity:0.15}),
    e("ellipse",{key:1,cx:50,cy:66,rx:24,ry:20,fill:"none",stroke:"#8B4513",strokeWidth:2.5}),
    e("path",{key:2,d:"M44 48 Q44 30 46 22 Q48 16 50 14 Q52 16 54 22 Q56 30 56 48",fill:"#A0522D",opacity:0.1,stroke:"#8B4513",strokeWidth:2.5}),
    e("ellipse",{key:3,cx:50,cy:14,rx:5,ry:3,fill:"#D2B48C",opacity:0.5,stroke:"#8B4513",strokeWidth:1.5}),
    e("path",{key:4,d:"M44 36c-10-2-16 2-18 8",stroke:"#8B4513",strokeWidth:2.5,strokeLinecap:"round",fill:"none"}),
    e("path",{key:5,d:"M56 34c12-2 16 10 14 22c-1 6-4 10-8 12",stroke:"#8B4513",strokeWidth:2.5,fill:"none"}),
    e("path",{key:6,d:"M34 60c4-2 8-2 12 0c4 2 8 2 12 0c4-2 8-2 12 0",stroke:"#D2691E",strokeWidth:1,opacity:0.35}),
    e("path",{key:7,d:"M46 72v8M42 76h8",stroke:"#D2691E",strokeWidth:1,opacity:0.25}),
    e("path",{key:8,d:"M34 86h32",stroke:"#8B4513",strokeWidth:2,strokeLinecap:"round"}),
  ]),
  coldbrew:(sz=64)=>mkSvg(sz,[
    e("rect",{key:0,x:24,y:20,width:52,height:66,rx:4,fill:"#6A8BA0",opacity:0.06}),
    e("rect",{key:1,x:24,y:20,width:52,height:66,rx:4,fill:"none",stroke:"#6A8BA0",strokeWidth:2.5}),
    e("rect",{key:2,x:22,y:10,width:56,height:12,rx:4,fill:"#AAA",opacity:0.2,stroke:"#888",strokeWidth:2}),
    e("rect",{key:3,x:26,y:28,width:48,height:54,rx:2,fill:"#3E2310",opacity:0.08}),
    e("circle",{key:4,cx:36,cy:36,r:2,fill:"#4A3020",opacity:0.15}),
    e("circle",{key:5,cx:50,cy:32,r:1.5,fill:"#4A3020",opacity:0.12}),
    e("circle",{key:6,cx:60,cy:38,r:2,fill:"#4A3020",opacity:0.15}),
    e("rect",{key:7,x:34,y:56,width:8,height:8,rx:2,fill:"#89CFF0",opacity:0.25,stroke:"#6A8BA0",strokeWidth:0.8}),
    e("rect",{key:8,x:52,y:60,width:7,height:7,rx:2,fill:"#89CFF0",opacity:0.2,stroke:"#6A8BA0",strokeWidth:0.8}),
    e("path",{key:9,d:"M28 24v56",stroke:"white",strokeWidth:1.5,opacity:0.15}),
    e("line",{key:10,x1:58,y1:4,x2:54,y2:28,stroke:"#6A8BA0",strokeWidth:2,strokeLinecap:"round",opacity:0.4}),
  ]),
  afa:(sz=64)=>mkSvg(sz,[
    e("ellipse",{key:0,cx:50,cy:14,rx:16,ry:5,fill:"#C0392B",opacity:0.15,stroke:"#C0392B",strokeWidth:2}),
    e("rect",{key:1,x:34,y:14,width:32,height:4,rx:1,fill:"#C0392B",opacity:0.08}),
    e("path",{key:2,d:"M34 18 L34 42 Q34 46 38 46 L62 46 Q66 46 66 42 L66 18",fill:"#FFF",opacity:0.08,stroke:"#C0392B",strokeWidth:2}),
    e("ellipse",{key:3,cx:50,cy:35,rx:10,ry:2,fill:"#6B4226",opacity:0.15}),
    e("line",{key:4,x1:38,y1:38,x2:62,y2:38,stroke:"#C0392B",strokeWidth:1,strokeDasharray:"2 2",opacity:0.3}),
    e("circle",{key:5,cx:44,cy:38,r:1,fill:"#C0392B",opacity:0.25}),
    e("circle",{key:6,cx:50,cy:38,r:1,fill:"#C0392B",opacity:0.25}),
    e("circle",{key:7,cx:56,cy:38,r:1,fill:"#C0392B",opacity:0.25}),
    e("path",{key:8,d:"M34 46 L34 78 Q34 84 40 84 L60 84 Q66 84 66 78 L66 46",fill:"#FFF",opacity:0.06,stroke:"#C0392B",strokeWidth:2.5}),
    e("path",{key:9,d:"M66 54c4-2 10 2 10 10s-6 14-10 12",stroke:"#C0392B",strokeWidth:2.5,fill:"none"}),
    e("path",{key:10,d:"M34 58c-12-2-16 6-14 16c1 6 6 10 14 8",stroke:"#C0392B",strokeWidth:2.5,fill:"none"}),
    e("path",{key:11,d:"M20 74l-6 8",stroke:"#C0392B",strokeWidth:2,strokeLinecap:"round"}),
    e("circle",{key:12,cx:14,cy:82,r:2,fill:"#C0392B",opacity:0.4}),
    e("path",{key:13,d:"M38 62c3-1 6-1 9 0c3 1 6 1 9 0",stroke:"#D4A574",strokeWidth:0.8,opacity:0.3}),
    e("text",{key:14,x:41,y:74,fill:"#C0392B",fontSize:10,fontWeight:800,fontFamily:"serif",opacity:0.25},"aFA"),
    e("path",{key:15,d:"M36 84h28",stroke:"#C0392B",strokeWidth:2,strokeLinecap:"round"}),
  ]),
};

// ===== DATA =====
const METHODS=[
  {id:"v60",name:"Hario V60",icon:"v60",color:"#C28B5A"},
  {id:"aeropress",name:"AeroPress",icon:"aeropress",color:"#8BA87E"},
  {id:"chemex",name:"Chemex",icon:"chemex",color:"#B8956A"},
  {id:"frenchpress",name:"French Press",icon:"frenchpress",color:"#9A7B6A"},
  {id:"cuccumella",name:"Cuccumella",icon:"cuccumella",color:"#C27B5A"},
  {id:"moka",name:"Moka Bialetti",icon:"moka",color:"#A0785E"},
  {id:"ibrik",name:"Ibrik / Cezve",icon:"ibrik",color:"#CD7F32"},
  {id:"jebena",name:"Jebena",icon:"jebena",color:"#8B4513"},
  {id:"coldbrew",name:"Cold Brew",icon:"coldbrew",color:"#6A8BA0"},
  {id:"afa",name:"AFA",icon:"afa",color:"#C0392B"},
];

const RECIPES=[
  {id:"hoffmann-v60",method:"v60",name:"Hoffmann Ultimate V60",author:"James Hoffmann",description:"Bloom con swirl, versate in due fasi, swirl finale. Ratio 1:16.7. Acqua pi√π calda possibile.",baseCoffee:30,baseWater:500,temperature:100,clicks:24,microns:700,grindDesc:"Medium-fine (22-25 click C40)",beans:["Etiopia Yirgacheffe lavato (floreale, agrumi)","Colombia Huila lavato (caramello, mela)","Kenya AA Nyeri (ribes, pomodoro)"],steps:[{text:"Bloom: versa 60g (2√ó dose). Swirl delicato.",waterAdd:60,duration:45},{text:"Versata decisa in spirale fino a 300g (60%).",waterAdd:240,duration:30},{text:"Versata pi√π lenta fino a 500g (100%).",waterAdd:200,duration:30},{text:"Stir: 1√ó orario, 1√ó antiorario. Swirl finale.",waterAdd:0,duration:10},{text:"Drawdown. Target letto piatto a 3:30.",waterAdd:0,duration:95}]},
  {id:"hoffmann-1cup",method:"v60",name:"Hoffmann Better 1 Cup V60",author:"James Hoffmann",description:"5 versate da 50g. Pi√π consistente per tazza singola.",baseCoffee:15,baseWater:250,temperature:100,clicks:20,microns:600,grindDesc:"Medium-fine",beans:["Etiopia Sidamo natural (frutti di bosco)","Guatemala Antigua lavato (cioccolato, nocciola)","Costa Rica Tarraz√∫ honey (miele, pesca)"],steps:[{text:"Versa 50g lentamente in 15s. Mescola/swirl bene.",waterAdd:50,duration:45},{text:"Seconda: 50g in ~10s (tot 100g). Attendi.",waterAdd:50,duration:15},{text:"Terza: 50g in ~10s (tot 150g). Attendi.",waterAdd:50,duration:15},{text:"Quarta: 50g in ~10s (tot 200g). Attendi.",waterAdd:50,duration:15},{text:"Quinta: 50g in ~10s (tot 250g). Swirl delicato.",waterAdd:50,duration:10},{text:"Drawdown. Target letto piatto ~2:30-3:00.",waterAdd:0,duration:80}]},
  {id:"kasuya-46",method:"v60",name:"Tetsu Kasuya 4:6 Method",author:"Tetsu Kasuya (WBrC 2016)",description:"Macinatura grossa (sale). 40% gusto (acidit√†/dolcezza), 60% intensit√†. 1:15.",baseCoffee:20,baseWater:300,temperature:90,clicks:30,microns:900,grindDesc:"Coarse (27-32 click C40)",beans:["Colombia Nari√±o lavato (panela, arancia)","El Salvador Pacamara honey (tropicale)","Brasile Cerrado natural (nocciola, cioccolato)"],steps:[{text:"Prima versata: 60g. Acidit√†.",waterAdd:60,duration:45},{text:"Seconda: 60g (120g). Dolcezza.",waterAdd:60,duration:45},{text:"Terza: 60g (180g). Corpo.",waterAdd:60,duration:45},{text:"Quarta: 60g (240g).",waterAdd:60,duration:45},{text:"Quinta: 60g (300g). Drawdown.",waterAdd:60,duration:60}]},
  {id:"winton-5pour",method:"v60",name:"Matt Winton 5-Pour",author:"Matt Winton (WBrC 2021)",description:"5 versate da 60g, medio-grossa, nessuna agitazione. Chiarezza e brillantezza.",baseCoffee:20,baseWater:300,temperature:93,clicks:30,microns:900,grindDesc:"Medium-coarse",beans:["Etiopia Guji lavato (gelsomino, bergamotto)","Kenya Kirinyaga AA (pompelmo, ribes)","Panama Geisha lavato (gelsomino, tropicale)"],steps:[{text:"60g dal centro verso l'esterno. Bloom 30s.",waterAdd:60,duration:45},{text:"Drawdown, poi 60g (tot 120g).",waterAdd:60,duration:40},{text:"Drawdown, 60g (tot 180g).",waterAdd:60,duration:40},{text:"Drawdown, 60g (tot 240g).",waterAdd:60,duration:40},{text:"60g (tot 300g). Drawdown ~3:30.",waterAdd:60,duration:45}]},
  {id:"hedrick-121",method:"v60",name:"Lance Hedrick 121",author:"Lance Hedrick",description:"1 Pour, 2 min bloom, 1 Pour. Semplicissimo. 1:17.",baseCoffee:18,baseWater:306,temperature:100,clicks:22,microns:660,grindDesc:"Medium-fine",beans:["Panama Geisha lavato (gelsomino, pesca)","Etiopia Yirgacheffe Kochere (limone, t√®)","Rwanda Nyamasheke lavato (arancia, floreale)"],steps:[{text:"Versa ~90g rapido. Spin deciso.",waterAdd:90,duration:10},{text:"Attendi 2 minuti (bloom lungo).",waterAdd:0,duration:110},{text:"Versata unica: 216g controllati.",waterAdd:216,duration:25},{text:"Spin delicato. Drawdown.",waterAdd:0,duration:75}]},
  {id:"rao-v60",method:"v60",name:"Scott Rao V60",author:"Scott Rao",description:"Bloom con scavo, versata continua, Rao Spin finale.",baseCoffee:22,baseWater:360,temperature:96,clicks:24,microns:720,grindDesc:"Medium-fine",beans:["Colombia Huila lavato (caramello, ciliegia)","Guatemala Huehuetenango (cioccolato, spezie)","Etiopia Sidamo lavato (limone, floreale)"],steps:[{text:"Bloom: 66g. Scava con cucchiaino.",waterAdd:66,duration:45},{text:"Versa tutto in spirale continua.",waterAdd:294,duration:75},{text:"Rao Spin. Drawdown.",waterAdd:0,duration:90}]},
  {id:"lucafausu-v60",method:"v60",name:"Lu Cafausu V60",author:"Lu Cafausu",description:"Precisione e definizione. Due versate controllate. 2:30-3:00.",baseCoffee:15,baseWater:250,temperature:93,clicks:23,microns:690,grindDesc:"Medium-fine (22-24 click)",beans:["Etiopia Guji natural (fragola, cioccolato)","Colombia Huila lavato (panela, mela verde)","Costa Rica honey (pesca, miele)"],steps:[{text:"Bloom: 40g lentamente.",waterAdd:40,duration:30},{text:"Prima versata in cerchi fino a ~150g.",waterAdd:110,duration:30},{text:"Seconda versata fino a 250g. Max 3 min.",waterAdd:100,duration:60},{text:"Drawdown.",waterAdd:0,duration:30}]},
  {id:"peng-wbrc2025",method:"v60",name:"George J. Peng WBrC 2025",author:"George Jinyang Peng (WBrC 2025)",description:"Solo Dripper + Melodrip. Temp. decrescenti (96‚Üí80¬∞C). Chiarezza estrema, <2 min. 40ppm TDS.",baseCoffee:15,baseWater:210,temperature:96,clicks:27,microns:810,grindDesc:"Medium (26-28 click C40)",beans:["Panama Geisha lavato (gelsomino, bergamotto)","Etiopia Yirgacheffe Kochere (t√®, lime)","Colombia Geisha honey (miele, floreale)"],steps:[{text:"Pre-heat: 80ml a 96¬∞C nel dripper (Solo/V60).",waterAdd:0,duration:15},{text:"Bloom: 30ml a 96¬∞C, 3 cerchi antiorari, 6s.",waterAdd:30,duration:24},{text:"A 0:30 ‚Äî 90ml a 96¬∞C in 10s.",waterAdd:90,duration:40},{text:"A 1:10 ‚Äî 90ml a 80¬∞C con Melodrip.",waterAdd:90,duration:40},{text:"Drawdown ~1:45. Servi a 50¬∞C.",waterAdd:0,duration:15}]},
  {id:"hoffmann-ap",method:"aeropress",name:"Hoffmann AeroPress",author:"James Hoffmann",description:"Standard (non invertito). Semplicissimo.",baseCoffee:11,baseWater:200,temperature:100,clicks:24,microns:720,grindDesc:"Medium-fine",beans:["Colombia Nari√±o lavato (dolce, bilanciato)","Etiopia natural (frutti di bosco, cacao)","Guatemala Antigua (nocciola, cioccolato)"],steps:[{text:"Versa tutta l'acqua rapida.",waterAdd:200,duration:10},{text:"Inserisci pistone. Non toccare.",waterAdd:0,duration:120},{text:"Swirl 3 volte.",waterAdd:0,duration:10},{text:"Attendi deposito fondi.",waterAdd:0,duration:30},{text:"Premi delicatamente.",waterAdd:0,duration:30}]},
  {id:"wac2024",method:"aeropress",name:"WAC 2024 ‚Äî George Stanica",author:"George Stanica (WAC 2024)",description:"Invertito, Melodrip, bypass freddo.",baseCoffee:18,baseWater:125,temperature:96,clicks:29,microns:870,grindDesc:"Medium",beans:["Panama Geisha lavato (gelsomino, bergamotto)","Etiopia Yirgacheffe Kochere (t√®, lime)","Kenya Nyeri AA (ribes nero, pompelmo)"],steps:[{text:"Invertito. 50g con Melodrip.",waterAdd:50,duration:10},{text:"Attendi.",waterAdd:0,duration:20},{text:"Mescola 3 volte.",waterAdd:0,duration:5},{text:"Aggiungi 75g.",waterAdd:75,duration:10},{text:"Attendi 1:50 totali.",waterAdd:0,duration:65},{text:"Capovolgi, swirl, premi 20s.",waterAdd:0,duration:25},{text:"Bypass: 36ml temp. ambiente.",waterAdd:36,duration:15}]},
  {id:"wac2025",method:"aeropress",name:"WAC 2025 ‚Äî N√©mo Pop",author:"N√©mo Pop (WAC 2025)",description:"Campione 2025. Upright, setacciato 200¬µm. Bypass 50¬∞C. 31cl Trailmaster (‚âàC40).",baseCoffee:18,baseWater:130,temperature:84,clicks:31,microns:930,grindDesc:"Medium-coarse (setacciato)",beans:["Etiopia Guji anaerobico (fragola, vino)","Colombia Pink Bourbon (tropicale, floreale)","Kenya Kirinyaga (pompelmo, pomodoro)"],steps:[{text:"70g bypass (50¬∞C) nel server.",waterAdd:70,duration:10},{text:"Macina, soffia, setaccia fini.",waterAdd:0,duration:15},{text:"60g a 84¬∞C nell'AeroPress.",waterAdd:60,duration:10},{text:"Mescola 15 secondi.",waterAdd:0,duration:15},{text:"Aggiungi 70g.",waterAdd:70,duration:10},{text:"Attendi 30s. Premi lento.",waterAdd:0,duration:45},{text:"Mescola con bypass. Servi.",waterAdd:0,duration:10}]},
  {id:"wendelboe-ap",method:"aeropress",name:"Tim Wendelboe AeroPress",author:"Tim Wendelboe",description:"Invertito e veloce. Light roast.",baseCoffee:14,baseWater:200,temperature:95,clicks:20,microns:600,grindDesc:"Medium-fine",beans:["Etiopia Halo Beriti natural (fragola, cacao)","Kenya Kiambu AA (ribes, agrumi)","Colombia Geisha lavato (gelsomino, lime)"],steps:[{text:"Invertito. Versa tutta l'acqua.",waterAdd:200,duration:10},{text:"Mescola 3 volte.",waterAdd:0,duration:5},{text:"Chiudi. Attendi.",waterAdd:0,duration:60},{text:"Capovolgi e premi 20s.",waterAdd:0,duration:20}]},
  {id:"lucafausu-ap-std",method:"aeropress",name:"Lu Cafausu AP Standard",author:"Lu Cafausu",description:"NON invertita. Pulita e brillante. 85-88¬∞C.",baseCoffee:15,baseWater:220,temperature:87,clicks:19,microns:570,grindDesc:"Fine-medium (18-20 click)",beans:["Etiopia Sidamo lavato (limone, gelsomino)","Colombia Huila lavato (caramello, arancia)","Brasile Cerrado natural (nocciola, cioccolato)"],steps:[{text:"Versa 220ml a 87¬∞C.",waterAdd:220,duration:10},{text:"Mescola 5-6 volte.",waterAdd:0,duration:10},{text:"Pistone per sigillare. Attendi.",waterAdd:0,duration:95},{text:"Pressa 30 secondi.",waterAdd:0,duration:30}]},
  {id:"lucafausu-ap-inv",method:"aeropress",name:"Lu Cafausu AP Invertita",author:"Lu Cafausu",description:"Invertita, pi√π corpo. 85¬∞C, fine.",baseCoffee:17,baseWater:230,temperature:85,clicks:15,microns:450,grindDesc:"Fine (14-16 click)",beans:["Etiopia Guji natural (frutti di bosco, vino)","Rwanda lavato (arancia, floreale)","Colombia Nari√±o (panela, ciliegia)"],steps:[{text:"Invertita. 230ml a 85¬∞C.",waterAdd:230,duration:10},{text:"Mescola.",waterAdd:0,duration:10},{text:"Attendi 2 minuti.",waterAdd:0,duration:100},{text:"Capovolgi. Pressa 30s.",waterAdd:0,duration:30}]},
  {id:"chemex-classic",method:"chemex",name:"Chemex Classica 6 Tazze",author:"Tradizionale",description:"Filtro spesso, tazza cristallina. 1:16.7.",baseCoffee:42,baseWater:700,temperature:96,clicks:30,microns:900,grindDesc:"Medium",beans:["Etiopia Yirgacheffe lavato (gelsomino, agrumi)","Colombia Huila lavato (panela, mela)","Guatemala Antigua (cioccolato, noce)"],steps:[{text:"Bloom: 2x caff√®. Mescola.",waterAdd:84,duration:45},{text:"Cerchi fino a met√†.",waterAdd:266,duration:60},{text:"Pausa breve.",waterAdd:0,duration:30},{text:"Versa il resto.",waterAdd:350,duration:60},{text:"Drawdown.",waterAdd:0,duration:105}]},
  {id:"hoffmann-chemex",method:"chemex",name:"Hoffmann Chemex",author:"James Hoffmann",description:"Adattamento V60 per Chemex. Bloom con stir, versate in 3-4 fasi. 1:16.7. Acqua bollente.",baseCoffee:30,baseWater:500,temperature:100,clicks:28,microns:840,grindDesc:"Medium-coarse (27-30 click C40)",beans:["Etiopia Yirgacheffe lavato (gelsomino, limone)","Kenya AA (ribes, pompelmo)","Colombia Huila lavato (caramello, ciliegia)"],steps:[{text:"Bloom: 60-90g. Stir per bagnare tutto.",waterAdd:75,duration:10},{text:"Attendi bloom 45s.",waterAdd:0,duration:35},{text:"Versa in cerchi fino a 300g.",waterAdd:225,duration:30},{text:"Aspetta che scenda 1cm. Versa a 500g.",waterAdd:200,duration:30},{text:"Swirl delicato. Drawdown 4:30-5:30.",waterAdd:0,duration:160}]},
  {id:"rao-chemex",method:"chemex",name:"Scott Rao Chemex",author:"Scott Rao",description:"Brew piccolo, versata rapida, stir bordi, Rao Spin. Rao consiglia max 475ml. 1:17.",baseCoffee:25,baseWater:425,temperature:97,clicks:28,microns:840,grindDesc:"Medium (27-29 click C40)",beans:["Colombia Huila lavato (caramello, ciliegia)","Guatemala Huehuetenango (cioccolato, spezie)","Etiopia Sidamo lavato (limone, floreale)"],steps:[{text:"Pre-wet: 38g. Scava con cucchiaino.",waterAdd:38,duration:10},{text:"Bloom 30s.",waterAdd:0,duration:25},{text:"Versa tutto (425g) rapido in cerchi.",waterAdd:387,duration:30},{text:"Stir bordi lento. Rao Spin.",waterAdd:0,duration:10},{text:"Drawdown. Totale: ~3:00.",waterAdd:0,duration:95}]},
  {id:"chemex-bypass",method:"chemex",name:"Chemex Bypass",author:"Specialty Contemporaneo",description:"Brew concentrato 1:12 + bypass acqua calda. Estrazione alta senza overextraction.",baseCoffee:30,baseWater:360,temperature:98,clicks:24,microns:720,grindDesc:"Medium-fine (23-25 click C40)",beans:["Etiopia Guji natural (fragola, cacao)","Panama Geisha lavato (gelsomino, bergamotto)","Kenya Nyeri AA (pompelmo, ribes)"],steps:[{text:"Bloom: 60g. Attendi.",waterAdd:60,duration:45},{text:"Versa rapido fino a 360g.",waterAdd:300,duration:30},{text:"Swirl. Drawdown ~2:30.",waterAdd:0,duration:90},{text:"Bypass: aggiungi 140ml acqua calda al server.",waterAdd:140,duration:15},{text:"Mescola. Totale in tazza: 500ml, ratio 1:16.7.",waterAdd:0,duration:10}]},
  {id:"chemex-1cup",method:"chemex",name:"Chemex 1 Tazza",author:"Specialty Singola",description:"Singola tazza Chemex. Macinatura pi√π fine per compensare. 1:16.",baseCoffee:15,baseWater:250,temperature:98,clicks:24,microns:720,grindDesc:"Medium-fine (23-25 click C40)",beans:["Etiopia Yirgacheffe Kochere (limone, t√®)","Colombia Pink Bourbon (tropicale, floreale)","Rwanda Nyamasheke lavato (arancia, miele)"],steps:[{text:"Bloom: 30g. Swirl.",waterAdd:30,duration:40},{text:"Versa lento fino a 150g.",waterAdd:120,duration:30},{text:"Fino a 250g.",waterAdd:100,duration:30},{text:"Drawdown 3:00-3:30.",waterAdd:0,duration:80}]},
  {id:"lucafausu-chemex-3inf",method:"chemex",name:"Lu Cafausu Chemex 3 Infusioni",author:"Lu Cafausu",description:"3 infusioni distinte. Filtro 3 lati sul beccuccio. Buca centrale.",baseCoffee:30,baseWater:500,temperature:96,clicks:28,microns:840,grindDesc:"Medium / medium-grosso",beans:["Etiopia Guji natural (fragola, cacao)","Kenya AA (pompelmo, ribes nero)","Panama Geisha (gelsomino, bergamotto)"],steps:[{text:"Filtro: 3 lati sul beccuccio. Buca centrale.",waterAdd:0,duration:15},{text:"PRIMA: 60-90g a cerchio.",waterAdd:75,duration:15},{text:"Aspetta 30s. Bloom.",waterAdd:0,duration:30},{text:"SECONDA: lenta, circolare fino a 350g.",waterAdd:275,duration:30},{text:"Stop 1:15. Pausa 30s.",waterAdd:0,duration:30},{text:"TERZA a 1:45: fino a 500g.",waterAdd:150,duration:30},{text:"Drawdown. Totale: 4-5 min.",waterAdd:0,duration:120}]},
  {id:"lucafausu-chemex-std",method:"chemex",name:"Lu Cafausu Chemex Standard",author:"Lu Cafausu",description:"Pulizia e trasparenza. >5:30 troppo fine, <4:00 troppo grosso.",baseCoffee:30,baseWater:500,temperature:94,clicks:27,microns:810,grindDesc:"Medium (26-28 click)",beans:["Colombia Nari√±o lavato (caramello, ciliegia)","Costa Rica Tarraz√∫ honey (pesca, miele)","Etiopia Sidamo lavato (t√®, limone)"],steps:[{text:"Bloom: 60ml.",waterAdd:60,duration:45},{text:"Versate lente fino a 300g.",waterAdd:240,duration:60},{text:"Fino a 500g.",waterAdd:200,duration:60},{text:"Drawdown 4:30-5:00.",waterAdd:0,duration:90}]},
  {id:"hoffmann-fp",method:"frenchpress",name:"Hoffmann French Press",author:"James Hoffmann",description:"NON premere! Rompi crosta, togli schiuma, aspetta.",baseCoffee:30,baseWater:500,temperature:100,clicks:32,microns:960,grindDesc:"Medium-coarse",beans:["Brasile Cerrado natural (nocciola, cioccolato)","Colombia Huila lavato (caramello, panela)","Sumatra Mandheling (spezie, terra, tabacco)"],steps:[{text:"Versa tutta l'acqua bollita.",waterAdd:500,duration:10},{text:"Crosta in superficie. Non toccare.",waterAdd:0,duration:240},{text:"Rompi crosta. Rimuovi schiuma.",waterAdd:0,duration:60},{text:"Attendi 5 min.",waterAdd:0,duration:300},{text:"Pistone alla superficie. Versa piano.",waterAdd:0,duration:30}]},
  {id:"lucafausu-fp-lungo",method:"frenchpress",name:"Lu Cafausu FP 4+4",author:"Lu Cafausu",description:"4 min infusione + 4 min attesa. Corpo con chiarezza.",baseCoffee:16,baseWater:250,temperature:93,clicks:31,microns:930,grindDesc:"Medium-coarse (30-32 click)",beans:["Etiopia Guji natural (frutti, cioccolato)","Colombia Huila lavato (panela, mela verde)","Guatemala Huehuetenango (spezie, cacao)"],steps:[{text:"Versa 250ml a 93¬∞C.",waterAdd:250,duration:10},{text:"Mescola 1 volta.",waterAdd:0,duration:10},{text:"Copri. Infusione 4 min.",waterAdd:0,duration:220},{text:"Rompi la crosta.",waterAdd:0,duration:15},{text:"Attendi altri 4 min.",waterAdd:0,duration:240},{text:"Pressa lento. Servi.",waterAdd:0,duration:20}]},
  {id:"lucafausu-fp-std",method:"frenchpress",name:"Lu Cafausu FP Standard",author:"Lu Cafausu",description:"Standard specialty. Cupping informali e test tostatura.",baseCoffee:30,baseWater:500,temperature:93,clicks:31,microns:930,grindDesc:"Medium-coarse (30-32 click)",beans:["Qualsiasi singola origine per cupping","Brasile natural (nocciola, corpo pieno)","Etiopia natural (frutti, complessit√†)"],steps:[{text:"Versa 500ml a 93¬∞C.",waterAdd:500,duration:10},{text:"Mescola con cucchiaio legno.",waterAdd:0,duration:10},{text:"Copri. Pistone in alto. 4 min.",waterAdd:0,duration:220},{text:"Pressa lento. Servi subito.",waterAdd:0,duration:20}]},
  {id:"classic-fp",method:"frenchpress",name:"French Press Classica",author:"Tradizionale",description:"Pressa completa. Corpo pieno.",baseCoffee:30,baseWater:500,temperature:96,clicks:34,microns:1020,grindDesc:"Coarse",beans:["Brasile Santos natural (nocciola, biscotto)","Sumatra Mandheling (terroso, spezie)","Colombia Supremo (cioccolato, equilibrato)"],steps:[{text:"Versa tutta l'acqua.",waterAdd:500,duration:10},{text:"Mescola.",waterAdd:0,duration:10},{text:"Copri. Attendi.",waterAdd:0,duration:220},{text:"Premi fino in fondo.",waterAdd:0,duration:20}]},
  {id:"cucc-trad",method:"cuccumella",name:"Cuccumella Tradizionale",author:"Tradizione Napoletana",description:"La napoletana vera: acqua nella parte bassa, fuoco, capovolgi quando bolle. Il cuppetiello.",baseCoffee:28,baseWater:200,temperature:100,clicks:20,microns:600,grindDesc:"Medium",beans:["Miscela napoletana (60% arabica, 40% robusta)","Brasile Santos natural (corpo, nocciola)","Etiopia Sidamo lavato (aromi, leggerezza)"],steps:[{text:"Caff√® nel filtro. Livella. NON pressare.",waterAdd:0,duration:20},{text:"Acqua nella caldaia (parte SENZA beccuccio).",waterAdd:200,duration:15},{text:"Assembla. Fuoco medio.",waterAdd:0,duration:15},{text:"Attendi ebollizione (~4-5 min).",waterAdd:0,duration:270},{text:"Vapore esce: CAPOVOLGI subito.",waterAdd:0,duration:10},{text:"Percolazione per gravit√†. Cuppetiello opzionale.",waterAdd:0,duration:240},{text:"Fine gocciolamento. Servi.",waterAdd:0,duration:30}]},
  {id:"cucc-spec",method:"cuccumella",name:"Cuccumella Specialty",author:"Caff√® Ernani",description:"Pi√π fine, pi√π alta temp.",baseCoffee:25,baseWater:200,temperature:94,clicks:18,microns:540,grindDesc:"Medium-fine",beans:["Etiopia Yirgacheffe lavato (floreale, t√®)","Colombia Huila lavato (dolce, pulito)","Costa Rica honey (miele, pesca)"],steps:[{text:"Caff√® nel filtro, livellato.",waterAdd:0,duration:20},{text:"Acqua a 94¬∞C.",waterAdd:0,duration:60},{text:"Versa. Assembla veloce.",waterAdd:200,duration:15},{text:"Capovolgi. Percolazione.",waterAdd:0,duration:210},{text:"Servi subito.",waterAdd:0,duration:45}]},
  {id:"lucafausu-cucc",method:"cuccumella",name:"Lu Cafausu Cuccumella",author:"Lu Cafausu",description:"Acqua FREDDA nel serbatoio ‚Üí sale a 100¬∞C. Nessuna pressatura. Gravit√†.",baseCoffee:29,baseWater:425,temperature:100,clicks:20,microns:600,grindDesc:"Medium (19-21 click)",beans:["Etiopia Guji natural anaerobico (vino, fragola)","Colombia Huila lavato (panela, dolcezza)","Brasile Cerrado natural chiara (nocciola, miele)"],steps:[{text:"Caff√® nel filtro. NON pressare.",waterAdd:0,duration:20},{text:"Acqua FREDDA nel serbatoio.",waterAdd:425,duration:15},{text:"Assembla. Fiamma BASSA.",waterAdd:0,duration:15},{text:"Attendi salita acqua (~4-5 min).",waterAdd:0,duration:270},{text:"Ribalta SUBITO.",waterAdd:0,duration:10},{text:"Percolazione. Totale: 6-8 min.",waterAdd:0,duration:120}]},
  {id:"cucc-gesha",method:"cuccumella",name:"Cuccumella Gesha Differenziale",author:"Lu Cafausu (Sperimentale)",description:"Preinfusione, stratificazione termica, doppia granulometria. Floreale e persistente.",baseCoffee:20,baseWater:300,temperature:95,clicks:"18+25",microns:750,grindDesc:"Doppia: 18cl (550¬µm) + 25cl (750¬µm)",beans:["Panama Geisha lavato (gelsomino, pesca, bergamotto)","Etiopia Gesha Village (floreale, tropicale)","Colombia Gesha honey (miele, gelsomino)"],steps:[{text:"Macina 10g a 550¬µm, 10g a 750¬µm.",waterAdd:0,duration:20},{text:"Nel filtro: prima grossa, poi fine. Carta sopra.",waterAdd:0,duration:15},{text:"Bloom esterno: 50ml a 95¬∞C sul caff√® nel filtro.",waterAdd:50,duration:40},{text:"Caldaia: 150ml a 95¬∞C.",waterAdd:150,duration:10},{text:"Stratifica: 100ml a 88¬∞C su cucchiaio.",waterAdd:100,duration:15},{text:"Assembla. Capovolgi subito.",waterAdd:0,duration:10},{text:"Percolazione lenta. Cuppetiello opzionale.",waterAdd:0,duration:360},{text:"Panno freddo sul beccuccio. 1 min.",waterAdd:0,duration:60},{text:"Versa. Degusta: naso, 1¬∞ sorso, 2¬∞ dopo 1 min.",waterAdd:0,duration:60}]},
  {id:"cucc-gesha-iced",method:"cuccumella",name:"Cuccumella Gesha Iced",author:"Lu Cafausu (Sperimentale)",description:"Bloom ghiacciato, stratificazione termica, caff√® su ghiaccio. Luminoso e persistente.",baseCoffee:20,baseWater:270,temperature:93,clicks:"18+25",microns:750,grindDesc:"Doppia: 18cl (550¬µm) + 25cl (750¬µm)",beans:["Panama Geisha lavato (gelsomino, agrumi)","Etiopia Yirgacheffe natural (fragola, bergamotto)","Colombia Pink Bourbon (tropicale, floreale)"],steps:[{text:"Macina 10g a 550¬µm, 10g a 750¬µm.",waterAdd:0,duration:20},{text:"Nel filtro: grossa, poi fine. Carta opzionale.",waterAdd:0,duration:15},{text:"Bloom GHIACCIATO: 45ml a 2-4¬∞C. Attendi 2 min.",waterAdd:45,duration:120},{text:"Caldaia: 130ml a 93¬∞C.",waterAdd:130,duration:10},{text:"Stratifica: 100ml a 85¬∞C su cucchiaio.",waterAdd:100,duration:15},{text:"100-120g ghiaccio nel bicchiere sotto.",waterAdd:0,duration:15},{text:"Assembla. Capovolgi. Goccia su ghiaccio.",waterAdd:0,duration:420},{text:"Mescola. Attendi 30s. Degusta.",waterAdd:0,duration:30}]},
  {id:"moka-trad",method:"moka",name:"Moka Tradizionale",author:"Tradizionale Italiana",description:"Fuoco basso, coperchio aperto, via al gorgoglio.",baseCoffee:15,baseWater:150,temperature:100,clicks:18,microns:540,grindDesc:"Fine-medium",beans:["Miscela italiana 100% arabica","Brasile Santos natural (corpo rotondo)","Colombia Supremo (equilibrato, dolce)"],steps:[{text:"Caldaia fino alla valvola.",waterAdd:150,duration:15},{text:"Caff√® nel filtro. NON pressare.",waterAdd:0,duration:15},{text:"Fuoco BASSO. Coperchio aperto.",waterAdd:0,duration:15},{text:"Esce lento, color miele.",waterAdd:0,duration:150},{text:"Gorgoglio: SUBITO via dal fuoco.",waterAdd:0,duration:15}]},
  {id:"moka-hoff",method:"moka",name:"Moka Hoffmann",author:"James Hoffmann",description:"Acqua pre-bollita. Meno amaro.",baseCoffee:15,baseWater:160,temperature:100,clicks:18,microns:540,grindDesc:"Fine-medium",beans:["Etiopia Sidamo lavato (floreale, leggero)","Colombia Huila lavato (dolce, pulito)","Guatemala Antigua (cioccolato, noce)"],steps:[{text:"Fai bollire acqua.",waterAdd:0,duration:60},{text:"Acqua bollente fino alla valvola.",waterAdd:160,duration:15},{text:"Caff√® senza pressare.",waterAdd:0,duration:10},{text:"Assembla. Fuoco medio-basso.",waterAdd:0,duration:15},{text:"Al gorgoglio via dal fuoco.",waterAdd:0,duration:90},{text:"Raffredda fondo sotto acqua.",waterAdd:0,duration:15}]},
  {id:"ibrik-trad",method:"ibrik",name:"Ibrik Tradizionale Turco",author:"Tradizione Turca",description:"Tre schiumate. Tazzine cini.",baseCoffee:7,baseWater:70,temperature:95,clicks:5,microns:150,grindDesc:"Extra-fine (polvere)",beans:["Brasile Santos scura (corpo, cacao)","Etiopia Djimmah (terroso, speziato)","Miscela turca tradizionale"],steps:[{text:"Caff√®. Zucchero se vuoi (prima acqua).",waterAdd:0,duration:15},{text:"Acqua fredda o tiepida.",waterAdd:70,duration:10},{text:"Mescola bene.",waterAdd:0,duration:15},{text:"Fuoco basso. Non mescolare.",waterAdd:0,duration:120},{text:"Sale schiuma: togli. Scende.",waterAdd:0,duration:20},{text:"Seconda schiumata.",waterAdd:0,duration:30},{text:"Terza. Versa con schiuma.",waterAdd:0,duration:20}]},
  {id:"ibrik-spec",method:"ibrik",name:"Ibrik Specialty ‚Äî Yƒ±ldƒ±zlƒ±",author:"Turgay Yƒ±ldƒ±zlƒ± (WC 2013)",description:"Una schiumata, tazzina pre-fredda, 60¬∞C.",baseCoffee:7,baseWater:70,temperature:60,clicks:8,microns:240,grindDesc:"Very fine",beans:["Etiopia Yirgacheffe lavato (floreale, delicato)","Panama Geisha (gelsomino, bergamotto)","Kenya AA (agrumi, brillante)"],steps:[{text:"Macina pi√π grosso del turco.",waterAdd:0,duration:15},{text:"Caff√® nell'ibrik.",waterAdd:0,duration:5},{text:"70ml acqua 60¬∞C.",waterAdd:70,duration:10},{text:"Mescola con paddle legno.",waterAdd:0,duration:15},{text:"Fuoco basso. NON mescolare.",waterAdd:0,duration:120},{text:"UNA schiumata. Togli.",waterAdd:0,duration:10},{text:"Versa in tazzina pre-fredda.",waterAdd:0,duration:15}]},
  {id:"jebena-trad",method:"jebena",name:"Jebena Buna ‚Äî Cerimonia Etiope",author:"Tradizione Etiope (Buna)",description:"Rituale sacro 1-3 ore. Condotta dalla donna di casa in habesha kemis (abito bianco). Tre tazze sacre: Abol, Tona, Baraka. Non si rifiuta la terza.",baseCoffee:30,baseWater:450,temperature:100,clicks:8,microns:240,grindDesc:"Polvere finissima (mukecha e zenezena)",beans:["Etiopia Harar natural (mirtillo, spezie, cacao)","Etiopia Yirgacheffe (gelsomino, agrumi, t√®)","Etiopia Jimma forest (selvaggio, terroso)"],steps:[{text:"ü™¥ PREPARAZIONE SPAZIO ‚Äî Spargi erba fresca profumata (ketema) e fiori gialli a terra. Accendi franchincenso (etan) o mirra nel bruciatore: scaccia gli spiriti cattivi e purifica l'aria. Disponi le tazzine cini (senza manico) sul rekebot (vassoio basso) sopra l'erba. Servi snack: popcorn, kolo (orzo/ceci tostati), himbasha (pane con semi di nigella).",waterAdd:0,duration:0},{text:"ü´ò LAVAGGIO ‚Äî Lava i chicchi verdi crudi nell'acqua, elimina bucce e impurit√†. Scola bene.",waterAdd:0,duration:120},{text:"üî• TOSTATURA ‚Äî Chicchi nel menkeshkesh (padella piatta a manico lungo). Fuoco basso su carboni. Scuoti e gira continuamente per 10-15 minuti. I chicchi passano da verdi ‚Üí dorati ‚Üí marroni ‚Üí neri lucidi e oleosi. First crack a ~5 min, second crack a ~8-10 min. Quando l'olio emerge e il fumo √® denso e profumato, √® pronta.",waterAdd:0,duration:900},{text:"üëÉ CONDIVISIONE AROMA ‚Äî Togli dal fuoco. Passa il menkeshkesh fumante sotto il naso di ogni ospite: ognuno inspira profondamente. √à segno di rispetto e ospitalit√†. Non farlo √® scortese.",waterAdd:0,duration:120},{text:"‚ö±Ô∏è MACINATURA ‚Äî Versa i chicchi caldi nel mukecha (mortaio di legno). Macina con lo zenezena (pestello) ritmicamente per 5-10 min fino a polvere finissima. Il suono ritmico del pestello richiama i vicini. La consistenza dev'essere come farina.",waterAdd:0,duration:600},{text:"‚òï INFUSIONE ‚Äî Acqua nella jebena (pentola in terracotta con collo stretto e beccuccio). Poni sui carboni. Quando bolle, aggiungi tutto il caff√® macinato. SPEZIE opzionali regionali: korarima (cardamomo etiope), cannella, chiodi di garofano, zenzero, o una foglia di tena adam (ruta etiope) intinta nel caff√®.",waterAdd:450,duration:600},{text:"üîÑ TRIPLA EBOLLIZIONE ‚Äî Porta a ebollizione. Versa in decanter per raffreddare. Riversa nella jebena. Riporta a ebollizione. Ripeti una terza volta. Questo processo concentra ed equalizza l'estrazione. Inserisci il filtro (tradizionalmente crine di cavallo) nel beccuccio.",waterAdd:0,duration:480},{text:"ü•á ABOL (·ä†·â¶·àç) ‚Äî Prima tazza, la pi√π forte e concentrata. Versa da ~30cm di altezza in flusso continuo senza interrompere, riempiendo ogni tazzina cini in fila. Il bambino pi√π piccolo porta la prima tazza all'ospite pi√π anziano. Si beve con molto zucchero (o sale nelle campagne). L'Abol rappresenta salute e godimento.",waterAdd:0,duration:0},{text:"ü•à TONA (·â∂·äì) ‚Äî Seconda tazza. Aggiungi acqua fresca sugli stessi fondi nella jebena. Riscalda. Pi√π delicata e morbida. √à il momento della conversazione vera: si discutono questioni in corso, si cercano soluzioni. Altro popcorn e kolo.",waterAdd:150,duration:600},{text:"ü•â BARAKA (·â†·à®·ä´) ‚Äî Terza e ultima. Ancora acqua fresca sugli stessi fondi. La pi√π leggera. Baraka significa 'benedizione'. Rifiutare la terza tazza √® scortese: chi la beve riceve la benedizione della casa e della famiglia. Porta fortuna.",waterAdd:100,duration:600}]},
  {id:"jebena-spec",method:"jebena",name:"Jebena Specialty Moderna",author:"Specialty Etiope",description:"Adattamento specialty con caff√® pre-tostato light roast. Singola ebollizione, senza spezie per pulizia in tazza. L'anima della cerimonia resta.",baseCoffee:24,baseWater:360,temperature:96,clicks:10,microns:300,grindDesc:"Fine (9-11 click C40)",beans:["Etiopia Yirgacheffe Kochere (limone, t√®)","Etiopia Guji Shakiso (pesca, floreale)","Etiopia Sidamo Bensa (frutti, miele)"],steps:[{text:"ü™¥ ATMOSFERA ‚Äî Incenso, erba fresca, fiori se disponibili. L'essenza della cerimonia √® la condivisione, anche senza tostatura dal vivo.",waterAdd:0,duration:0},{text:"‚òï Caff√® pre-tostato light roast. Macina fine (C40 ~10cl, o mukecha tradizionale). Consistenza sabbia fine.",waterAdd:0,duration:0},{text:"ü´ñ Acqua a 96¬∞C nella jebena. Aggiungi caff√®.",waterAdd:360,duration:15},{text:"üî• Fuoco basso. Porta lentamente a ebollizione (~5 min).",waterAdd:0,duration:300},{text:"Schiuma sale al collo: togli dal fuoco. Riposa 2 min per far depositare i fondi.",waterAdd:0,duration:120},{text:"ü•á ABOL ‚Äî Versa da 30cm nelle cini. Note floreali, agrumi. Foglia di tena adam (ruta) nella tazzina, opzionale.",waterAdd:0,duration:0},{text:"ü•à TONA ‚Äî Stessi fondi + acqua fresca. Riscalda. Pi√π delicata e rotonda.",waterAdd:100,duration:300},{text:"ü•â BARAKA ‚Äî Ultima. +80ml sugli stessi fondi. La pi√π leggera. Benedizione.",waterAdd:80,duration:300}]},
  {id:"coldbrew-conc",method:"coldbrew",name:"Cold Brew Concentrato",author:"Classico",description:"12-24h. Diluisci 1:1.",baseCoffee:100,baseWater:1000,temperature:0,clicks:36,microns:1080,grindDesc:"Very coarse",beans:["Brasile Cerrado natural (cioccolato, nocciola)","Colombia Supremo (dolce, rotondo)","Sumatra Mandheling (terroso, spezie, corpo)"],steps:[{text:"Caff√® grosso in barattolo.",waterAdd:0,duration:15},{text:"Acqua ambiente. Mescola.",waterAdd:1000,duration:30},{text:"Copri. Frigo 12-24h.",waterAdd:0,duration:15},{text:"Filtra.",waterAdd:0,duration:15},{text:"Diluisci 1:1.",waterAdd:0,duration:10}]},
  {id:"japanese-iced",method:"coldbrew",name:"Japanese Iced Coffee",author:"Specialty",description:"V60 su ghiaccio. Raffreddamento istantaneo.",baseCoffee:20,baseWater:200,temperature:96,clicks:20,microns:600,grindDesc:"Medium-fine",beans:["Etiopia Yirgacheffe lavato (limone, gelsomino)","Kenya AA (pompelmo, ribes)","Colombia Pink Bourbon (tropicale, fresco)"],steps:[{text:"120g ghiaccio nel server.",waterAdd:0,duration:15},{text:"Bloom: 40ml calda.",waterAdd:40,duration:45},{text:"Versa fino a 200ml.",waterAdd:160,duration:90},{text:"Swirl. Drawdown.",waterAdd:0,duration:60},{text:"Mescola con ghiaccio.",waterAdd:0,duration:15}]},
  {id:"afa-base",method:"afa",name:"AFA ‚Äî Ricetta Base",author:"Progetto aFA",description:"Neo-cuccumella ceramica a gravit√†. Filtro carta + ceramico. 5-6:30 min.",baseCoffee:18,baseWater:300,temperature:93,clicks:28,microns:850,grindDesc:"Medium-coarse (800-900¬µm)",beans:["Etiopia Guji natural anaerobico (fragola, vino)","Colombia Huila lavato (panela, mela)","Brasile Cerrado natural tost. chiara (nocciola, miele)"],steps:[{text:"Carta XL ‚àÖ73mm. Risciacqua.",waterAdd:0,duration:15},{text:"18g macinati, livellati.",waterAdd:0,duration:10},{text:"Bloom: 45ml, 15-20s. Pausa 35s.",waterAdd:45,duration:40},{text:"Seconda versata spirale fino 170ml.",waterAdd:125,duration:30},{text:"Terza versata centrata fino 300ml.",waterAdd:130,duration:30},{text:"Copri. Percolazione a gravit√†.",waterAdd:0,duration:240},{text:"Totale: 5:00-6:30. Servi.",waterAdd:0,duration:30}]},
  {id:"afa-brillante",method:"afa",name:"AFA ‚Äî Tazza Brillante",author:"Progetto aFA",description:"Pi√π acqua, macinatura leggermente pi√π fine. Acidit√† elegante e chiarezza.",baseCoffee:18,baseWater:295,temperature:93,clicks:27,microns:835,grindDesc:"Medium (820-850¬µm)",beans:["Etiopia Yirgacheffe lavato (gelsomino, limone)","Kenya Nyeri AA (ribes, pompelmo)","Panama Geisha lavato (bergamotto, t√®)"],steps:[{text:"Carta XL. Risciacqua.",waterAdd:0,duration:15},{text:"18g macinati.",waterAdd:0,duration:10},{text:"Bloom: 45ml. Pausa 35s.",waterAdd:45,duration:40},{text:"Versata spirale fino 170ml.",waterAdd:125,duration:30},{text:"Centrata fino 295ml.",waterAdd:125,duration:30},{text:"Copri. Percola. 5:15-5:45.",waterAdd:0,duration:240},{text:"Servi.",waterAdd:0,duration:10}]},
  {id:"afa-rotonda",method:"afa",name:"AFA ‚Äî Tazza Rotonda",author:"Progetto aFA",description:"Meno acqua, pi√π grossa. Corpo rotondo e dolcezza.",baseCoffee:18,baseWater:270,temperature:94,clicks:29,microns:880,grindDesc:"Medium-coarse (880-900¬µm)",beans:["Colombia Huila lavato (caramello, ciliegia)","Brasile Cerrado natural (nocciola, cioccolato)","Guatemala Huehuetenango (spezie, cacao)"],steps:[{text:"Carta XL. Risciacqua.",waterAdd:0,duration:15},{text:"18g macinati.",waterAdd:0,duration:10},{text:"Bloom: 40ml. Pausa 35s.",waterAdd:40,duration:40},{text:"Versata spirale fino 160ml.",waterAdd:120,duration:30},{text:"Centrata fino 270ml.",waterAdd:110,duration:30},{text:"Copri. Percola. 5:45-6:15.",waterAdd:0,duration:280},{text:"Servi.",waterAdd:0,duration:10}]},
];

const T={bg:"#1A1410",surface:"#251E18",surfaceHi:"#302820",accent:"#C28B5A",accentLight:"#E8B882",accentDim:"#8A6540",text:"#F2EBE3",textSec:"#9A8B7A",textDim:"#6A5E52",green:"#7CAA6E",red:"#C27060",border:"#3A3028"};
const fmt=s=>{if(s>=3600)return Math.floor(s/3600)+"h "+String(Math.floor((s%3600)/60)).padStart(2,"0")+"m";return Math.floor(s/60)+":"+String(s%60).padStart(2,"0");};
const beep=(f=880,d=120)=>{try{const c=new(window.AudioContext||window.webkitAudioContext)();const o=c.createOscillator();const g=c.createGain();o.frequency.value=f;o.connect(g);g.connect(c.destination);g.gain.value=0.3;o.start();setTimeout(()=>{o.stop();c.close();},d);}catch(x){}};
const dBeep=()=>{try{navigator.vibrate&&navigator.vibrate(150)}catch(x){}beep(880,100);setTimeout(()=>beep(1100,150),180);};
const tBeep=()=>{try{navigator.vibrate&&navigator.vibrate([200,100,200])}catch(x){}beep(880,80);setTimeout(()=>beep(1100,80),150);setTimeout(()=>beep(1320,200),300);};
const tTime=r=>r.steps.reduce((a,s)=>a+s.duration,0);
const mObj=id=>METHODS.find(m=>m.id===id);

// LocalStorage helper
const LS={get:k=>{try{return JSON.parse(localStorage.getItem(k));}catch(e){return null;}},set:(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v));}catch(e){}}};

// ===== APP =====
function cl(min,vw,max){const w=Math.min(window.innerWidth,720);const v=w*vw/100;return Math.max(min,Math.min(max,v))+"px";}
const TF={xl:()=>cl(22,5.5,32),lg:()=>cl(18,4.5,26),md:()=>cl(16,4,22),sm:()=>cl(14,3.5,18),bLg:()=>cl(14,3.2,17),bMd:()=>cl(13,3,16),bSm:()=>cl(11,2.5,14)};
function App(){
  const[view,setView]=useState("home");
  const[selM,setSelM]=useState(null);
  const[selR,setSelR]=useState(null);
  const[cc,setCc]=useState(null);
  const[cs,setCs]=useState(0);
  const[se,setSe]=useState(0);
  const[te,setTe]=useState(0);
  const[run,setRun]=useState(false);
  const[done,setDone]=useState(false);
  const ir=useRef(null);
  const[hist,setHist]=useState(()=>LS.get("brew_history")||[]);
  const[customR,setCustomR]=useState(()=>LS.get("custom_recipes")||[]);
  const[rat,setRat]=useState(0);
  const[notes,setNotes]=useState("");
  // Custom recipe form state
  const[fn,setFn]=useState("");
  const[fa,setFa]=useState("");
  const[fd,setFd]=useState("");
  const[fm,setFm]=useState("v60");
  const[fc2,setFc2]=useState("15");
  const[fw2,setFw2]=useState("250");
  const[ft2,setFt2]=useState("93");
  const[fk2,setFk2]=useState("24");
  const[fmu2,setFmu2]=useState("720");
  const[fgd2,setFgd2]=useState("Medium-fine");
  const[fst,setFst]=useState([{text:"",waterAdd:0,duration:30}]);
  const sH=h=>{setHist(h);LS.set("brew_history",h);};
  const sC=c=>{setCustomR(c);LS.set("custom_recipes",c);};
  const ALL_R=[...RECIPES,...customR];

  const gS=useCallback(()=>{
    if(!selR)return null;const c=cc??selR.baseCoffee;const m=c/selR.baseCoffee;
    return{...selR,coffee:c,water:Math.round(selR.baseWater*m),steps:selR.steps.map(s=>({...s,waterAdd:Math.round(s.waterAdd*m)})),mult:m};
  },[selR,cc]);


  // Install prompt detection
  useEffect(()=>{
    const r=gS();if(!r)return;const curDur=r.steps[cs]?.duration;
    if(curDur===0){setRun(false);setSe(0);return;}
    if(run){ir.current=setInterval(()=>{
      setSe(p=>{const r=gS();if(!r)return p;const d=r.steps[cs]?.duration||999;
        if(p+1>=d){if(cs<r.steps.length-1){dBeep();setCs(c=>c+1);return 0;}else{tBeep();setRun(false);setDone(true);return p+1;}}return p+1;});
      setTe(p=>p+1);},1000);}
    return()=>clearInterval(ir.current);
  },[run,cs,gS]);

  const start=()=>{setCs(0);setSe(0);setTe(0);setRun(true);setDone(false);setRat(0);setNotes("");setView("brew");beep(660,200);};
  const skip=()=>{const r=gS();if(!r)return;if(cs<r.steps.length-1){dBeep();setCs(c=>c+1);setSe(0);const nextDur=r.steps[cs+1]?.duration;if(nextDur>0)setRun(true);}else{tBeep();setRun(false);setDone(true);}};
  const home=()=>{setView("home");setSelM(null);setSelR(null);setRun(false);setDone(false);setCc(null);};
  const initForm=(r)=>{setFn(r?r.name:"");setFa(r?r.author:"");setFd(r?r.description:"");setFm(r?r.method:"v60");setFc2(r?String(r.baseCoffee):"15");setFw2(r?String(r.baseWater):"250");setFt2(r?String(r.temperature):"93");setFk2(r?String(r.clicks):"24");setFmu2(r?String(r.microns):"720");setFgd2(r?r.grindDesc:"Medium-fine");setFst(r?[...r.steps]:[{text:"",waterAdd:0,duration:30}]);};
  const save=()=>{const r=gS();if(!r)return;sH([{id:Date.now(),recipeName:r.name,method:r.method,coffee:r.coffee,water:r.water,clicks:r.clicks,temperature:r.temperature,rating:rat,notes,date:new Date().toLocaleDateString("it-IT"),time:new Date().toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})},...hist].slice(0,50));home();};

  const S={
    pg:{minHeight:"100dvh",background:T.bg,color:T.text,fontFamily:"'DM Sans','Helvetica Neue',sans-serif",maxWidth:720,margin:"0 auto",padding:"0 env(safe-area-inset-right) 0 env(safe-area-inset-left)"},
    hd:{padding:"14px 16px",display:"flex",alignItems:"center",gap:"12px",borderBottom:"1px solid "+T.border},
    ht:{fontSize:TF.lg(),fontWeight:700,fontFamily:"'Playfair Display',Georgia,serif",lineHeight:1.2},
    cd:{background:T.surface,borderRadius:16,padding:20,marginBottom:12,border:"1px solid "+T.border,cursor:"pointer",overflow:"hidden"},
    pl:{display:"inline-block",padding:"5px 12px",borderRadius:20,fontSize:14,fontWeight:600,background:T.surfaceHi,color:T.textSec},
    bt:(b,f)=>({padding:"16px 24px",borderRadius:14,border:"none",background:b||T.accent,color:f||"#1A1410",fontWeight:700,fontSize:18,cursor:"pointer",fontFamily:"inherit",width:"100%",letterSpacing:0.2}),
    ib:{width:44,height:44,borderRadius:22,border:"none",background:T.accent+"1A",color:T.text,display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",transition:"background 0.15s"},
    ibBack:{height:40,borderRadius:20,border:"2px solid #C0392B",background:"#C0392B18",color:"#C0392B",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",padding:"0 14px",gap:4},
    ibSm:{width:36,height:36,borderRadius:18,border:"1px solid "+T.border,background:T.surface,color:T.text,display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer"}
  };

  const Ic=(id,sz=64)=>{const fn=Illust[id];return fn?fn(sz):null;};

  // HOME
  if(view==="home")return e("div",{style:S.pg},
    e("div",{style:{padding:"28px 20px 12px"}},
      e("div",{style:{fontSize:TF.xl(),color:T.accent,fontWeight:800,letterSpacing:"-0.02em",fontFamily:"'Playfair Display',Georgia,serif",marginBottom:4,lineHeight:1.2}},"The Cafausica Brew Guide"),
      e("div",{style:{fontSize:TF.bLg(),fontWeight:400,fontFamily:"'DM Sans',sans-serif",lineHeight:1.4,color:T.textDim,fontStyle:"italic",letterSpacing:"0.02em"}},"Coffee as gesture, gravity and word"),
      e("p",{style:{color:T.textSec,fontSize:TF.bLg(),marginTop:8}},ALL_R.length+" ricette ¬∑ timer ¬∑ grinder clicks"),
    ),
    e("div",{style:{padding:"8px 16px 0"}},
      e("div",{style:{fontSize:TF.bSm(),color:T.textDim,fontWeight:600,letterSpacing:"0.08em",textTransform:"uppercase",marginBottom:12,paddingLeft:4}},"Metodo"),
      e("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(140px,1fr))",gap:12}},
        METHODS.map(m=>{const cnt=ALL_R.filter(r=>r.method===m.id).length;return e("div",{key:m.id,onClick:()=>{setSelM(m.id);setView("method");},style:{...S.cd,padding:14,display:"flex",flexDirection:"column",alignItems:"center",gap:6,textAlign:"center",marginBottom:0}},Ic(m.icon,56),e("div",{style:{fontWeight:700,fontSize:TF.bMd(),lineHeight:1.3}},m.name),e("div",{style:{fontSize:12,color:T.textSec}},cnt+" "+(cnt===1?"ricetta":"ricette")));})
      ),
    ),
    hist.length>0&&e("div",{style:{padding:"14px 16px 4px"}},e("div",{onClick:()=>setView("history"),style:{...S.cd,display:"flex",alignItems:"center",gap:12}},ICO.history(20),e("div",null,e("div",{style:{fontWeight:700,fontSize:TF.bLg()}},"I tuoi Brew"),e("div",{style:{fontSize:14,color:T.textSec}},hist.length+" salvati")),e("div",{style:{marginLeft:"auto"}},ICO.right(16)))),
    e("div",{style:{padding:"4px 16px 6px"}},e("div",{onClick:()=>setView("grind"),style:{...S.cd,display:"flex",alignItems:"center",gap:12,cursor:"pointer"}},
      e("div",{style:{fontSize:22,width:24,textAlign:"center"}},"\u2699"),
      e("div",null,e("div",{style:{fontWeight:700,fontSize:TF.bLg()}},"Guida Granulometria"),e("div",{style:{fontSize:14,color:T.textSec}},"Macinini ¬∑ click ¬∑ diagnostica")),
      e("div",{style:{marginLeft:"auto"}},ICO.right(16)),
    )),
    e("div",{style:{padding:"4px 16px 6px"}},e("div",{onClick:()=>{initForm(null);setView("addrecipe");},style:{...S.cd,display:"flex",alignItems:"center",gap:12,cursor:"pointer",border:"1px dashed "+T.accent}},
      ICO.plus(20),
      e("div",null,e("div",{style:{fontWeight:700,fontSize:TF.bLg(),color:T.accent}},"Crea la tua Ricetta"),e("div",{style:{fontSize:14,color:T.textSec}},customR.length>0?customR.length+" ricette personali":"Aggiungi ricette personalizzate")),
      e("div",{style:{marginLeft:"auto"}},ICO.right(16)),
    )),
    e("div",{style:{padding:"6px 16px"}},
      e("div",{style:{...S.cd,cursor:"default",background:"linear-gradient(135deg,#251E18 0%,#302820 100%)",border:"1px solid #C0392B44"}},
        e("div",{style:{fontSize:13,fontWeight:700,fontFamily:"'Playfair Display',Georgia,serif",color:"#C0392B",marginBottom:8,letterSpacing:0.5}},"Progetto aFA"),
        e("div",{style:{fontSize:13,color:T.textSec,lineHeight:1.6,marginBottom:10}},"Nessun motore, nessuna pressione. Solo gravit√†. La aFA √® una neo-cuccumella in ceramica: oggetto-manifesto che sottrae velocit√† al caff√® per restituire tempo alla parola e al gesto condiviso."),
        e("a",{href:"https://paypal.me/elleenne",target:"_blank",rel:"noopener",style:{display:"block",padding:"14px 20px",borderRadius:12,background:"#C0392B",color:"#FFF",fontWeight:700,fontSize:16,textAlign:"center",textDecoration:"none",marginBottom:8}},"Sostieni il progetto aFA"),
        e("div",{style:{display:"flex",gap:8}},
          e("a",{href:"afa-manifesto.pdf",target:"_blank",rel:"noopener",style:{flex:1,display:"block",padding:"12px 10px",borderRadius:10,border:"1px solid #C0392B55",color:"#C0392B",fontWeight:600,fontSize:14,textAlign:"center",textDecoration:"none"}},"Leggi il Manifesto"),
          typeof navigator!=="undefined"&&navigator.share?e("button",{onClick:()=>{try{navigator.share({title:"The Cafausica Brew Guide ‚Äî Progetto aFA",text:"Neo-cuccumella ceramica a gravit√†. Un gesto di sottrazione e cura.",url:window.location.href})}catch(x){}},style:{flex:1,padding:"12px 10px",borderRadius:10,border:"1px solid "+T.border,color:T.textSec,fontWeight:600,fontSize:14,background:"none",cursor:"pointer"}},"Condividi"):null,
        ),
      ),
    ),
    e("div",{style:{padding:"16px 20px 32px",textAlign:"center"}},e("div",{style:{fontSize:11,color:T.textDim,letterSpacing:0.5}},"C40 ~30¬µm/click ¬∑ "+ALL_R.length+" ricette ¬∑ 10 metodi"),e("div",{style:{fontSize:10,color:T.textDim+"99",marginTop:8,letterSpacing:2,fontStyle:"italic"}},"Lu Cafausu"),
          e("div",{style:{display:"flex",justifyContent:"center",gap:16,marginTop:10}},
            e("a",{href:"https://lacolemon.org/",target:"_blank",rel:"noopener",style:{fontSize:11,color:T.textDim,textDecoration:"none",borderBottom:"1px solid "+T.textDim+"44"}},"Lac O Le Mon"),
            e("a",{href:"https://lucafausu.wordpress.com/",target:"_blank",rel:"noopener",style:{fontSize:11,color:T.textDim,textDecoration:"none",borderBottom:"1px solid "+T.textDim+"44"}},"Lu Cafausu"),
          )),
  );

  // METHOD
  if(view==="method"){const mo=mObj(selM);const recs=ALL_R.filter(r=>r.method===selM);return e("div",{style:S.pg},
    e("div",{style:S.hd},e("button",{onClick:home,style:S.ibBack},ICO.back(22,"#C0392B"),e("span",{style:{fontSize:13,fontWeight:700}},"Indietro")),Ic(mo?.icon,28),e("span",{style:{...S.ht,fontSize:TF.md()}},mo?.name),e("span",{style:{marginLeft:"auto",fontSize:12,color:T.textSec}},recs.length+" ricette")),
    e("div",{style:{padding:20}},recs.map(r=>e("div",{key:r.id,onClick:()=>{setSelR(r);setCc(r.baseCoffee);setView("recipe");},style:S.cd},
      e("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"start",marginBottom:6}},e("h3",{style:{fontWeight:700,fontSize:TF.md(),fontFamily:"'Playfair Display',Georgia,serif",flex:1,paddingRight:8,lineHeight:1.25}},r.name),r.custom&&e("span",{style:{fontSize:11,background:T.accent+"33",color:T.accent,padding:"2px 8px",borderRadius:8,fontWeight:700,marginRight:6}},"TUA"),e("span",{style:S.pl},r.clicks+" click")),
      e("div",{style:{fontSize:TF.bMd(),color:T.textSec,marginBottom:8,lineHeight:1.5}},r.description),
      e("div",{style:{display:"flex",gap:14,flexWrap:"wrap",fontSize:15,color:T.textDim,alignItems:"center"}},e("span",null,r.baseCoffee+"g"),e("span",null,r.baseWater+"ml"),e("span",null,"1:"+(r.baseWater/r.baseCoffee).toFixed(1)),e("span",null,r.temperature>0?r.temperature+"¬∞C":"Fredda"),e("span",null,"~"+fmt(tTime(r))),
        r.custom&&e("button",{onClick:ev=>{ev.stopPropagation();setSelR(r);initForm(r);setView("editrecipe");},style:{marginLeft:"auto",fontSize:13,color:T.accent,fontWeight:700,background:"none",border:"1px solid "+T.accent+"66",padding:"4px 12px",borderRadius:8,cursor:"pointer"}},"\u270E Modifica")),
    ))),
  );}

  // RECIPE
  if(view==="recipe"&&selR){const sc=gS();if(!sc)return null;const mo=mObj(sc.method);let cW=0;return e("div",{style:S.pg},
    e("div",{style:S.hd},e("button",{onClick:()=>setView("method"),style:S.ibBack},ICO.back(22,"#C0392B"),e("span",{style:{fontSize:13,fontWeight:700}},"Indietro")),e("span",{style:{...S.ht,fontSize:TF.md(),flex:1}},sc.name)),
    e("div",{style:{padding:20}},
      e("div",{style:{textAlign:"center",marginBottom:14}},Ic(mo?.icon,80),e("div",{style:{fontSize:12,color:T.textSec,fontWeight:500,marginTop:4,letterSpacing:0.5}},"di "+sc.author)),
      e("div",{style:{...S.cd,background:T.surfaceHi,cursor:"default"}},
        e("div",{style:{fontSize:10,color:T.textDim,fontWeight:700,letterSpacing:2,textTransform:"uppercase",marginBottom:12,textAlign:"center"}},"PARAMETRI"),
        e("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}},
          [["Caff√®",sc.coffee+"g"],["Acqua",sc.water+"ml"],["Temperatura",sc.temperature>0?sc.temperature+"¬∞":"Fredda"],["Click Comandante",sc.clicks]].map(([l,v],i)=>e("div",{key:i,style:{textAlign:"center"}},e("div",{style:{fontSize:TF.lg(),fontWeight:800,color:T.accentLight,fontVariantNumeric:"tabular-nums"}},v),e("div",{style:{fontSize:14,color:T.textSec}},l)))
        ),
        e("div",{style:{marginTop:12,textAlign:"center",padding:"8px 0",borderTop:"1px solid "+T.border}},e("span",{style:{fontSize:13,color:T.textSec}},sc.grindDesc+" ¬∑ ~"+sc.microns+"¬µm ¬∑ 1:"+(sc.water/sc.coffee).toFixed(1))),
      ),
      sc.beans&&sc.beans.length>0&&e("div",{style:{...S.cd,cursor:"default",padding:16}},
        e("div",{style:{fontSize:12,color:T.accent,fontWeight:700,letterSpacing:1,textTransform:"uppercase",marginBottom:10}},"Caff√® suggeriti"),
        sc.beans.map((b,i)=>e("div",{key:i,style:{fontSize:16,color:T.textSec,lineHeight:1.6,paddingLeft:10,borderLeft:"2px solid "+T.accentDim,marginBottom:6}},b)),
      ),
      e("div",{style:{...S.cd,display:"flex",alignItems:"center",justifyContent:"center",gap:20,padding:12,cursor:"default"}},
        e("div",{style:{fontSize:11,color:T.textSec,fontWeight:600}},"DOSE"),
        e("button",{onClick:()=>setCc(Math.max(1,(cc??selR.baseCoffee)-1)),style:S.ibSm},ICO.minus(14)),
        e("div",{style:{fontSize:32,fontWeight:800,minWidth:60,textAlign:"center"}},sc.coffee+"g"),
        e("button",{onClick:()=>setCc((cc??selR.baseCoffee)+1),style:S.ibSm},ICO.plus(14)),
      ),
      e("div",{style:{marginBottom:14}},
        e("div",{style:{fontSize:15,color:T.textDim,fontWeight:600,letterSpacing:1,textTransform:"uppercase",marginBottom:12}},sc.steps.length+" step ¬∑ ~"+fmt(tTime(sc))),
        sc.steps.map((st,i)=>{cW+=st.waterAdd;return e("div",{key:i,style:{display:"flex",gap:10,marginBottom:8}},
          e("div",{style:{width:30,height:30,borderRadius:15,background:T.surfaceHi,border:"2px solid "+T.accentDim,display:"flex",alignItems:"center",justifyContent:"center",fontSize:13,fontWeight:700,color:T.accent,flexShrink:0,marginTop:2}},i+1),
          e("div",{style:{flex:1}},
            e("div",{style:{fontSize:TF.bLg(),lineHeight:1.5,marginBottom:3}},st.text),
            e("div",{style:{display:"flex",gap:10,flexWrap:"wrap"}},
              st.waterAdd>0&&e("span",{style:{fontSize:14,color:T.accent}},"+"+st.waterAdd+"ml (tot:"+cW+"ml)"),
              st.duration>0&&e("span",{style:{fontSize:15,color:T.textDim}},fmt(st.duration)),
            ),
          ),
        );})
      ),
      e("button",{onClick:start,style:{...S.bt("#7CAA6E","#FFF"),boxShadow:"0 4px 20px rgba(124,170,110,0.25)",letterSpacing:0.5}},e("span",{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:10}},ICO.play(16,"#FFF")," Inizia il Brew")),
      e("div",{style:{height:28}}),
    ),
  );}

  // BREW
  if(view==="brew"&&selR){
    const sc=gS();if(!sc)return null;const st=sc.steps[cs];const isDesc=st?.duration===0;const dur=isDesc?1:st?.duration||1;const pr=isDesc?0:Math.min(se/dur,1);
    let cW=0;for(let i=0;i<=cs;i++)cW+=sc.steps[i].waterAdd;

    if(done)return e("div",{style:S.pg},
      e("div",{style:{padding:"32px 20px",textAlign:"center"}},
        Ic(mObj(sc.method)?.icon,72),
        e("h2",{style:{fontSize:TF.lg(),fontWeight:800,fontFamily:"'Playfair Display',Georgia,serif",margin:"8px 0 4px",letterSpacing:"-0.02em"}},"Brew Completo!"),
        e("p",{style:{color:T.textSec,fontSize:17}},sc.name),
        e("p",{style:{color:T.accent,fontSize:28,fontWeight:700,marginTop:6}},fmt(te)),
      ),
      e("div",{style:{padding:"0 20px"}},
        e("div",{style:{...S.cd,cursor:"default"}},
          e("div",{style:{fontSize:11,color:T.textDim,fontWeight:600,textTransform:"uppercase",letterSpacing:1,marginBottom:12,textAlign:"center"}},"Come √® venuto?"),
          e("div",{style:{display:"flex",justifyContent:"center",gap:6,marginBottom:14}},
            [1,2,3,4,5].map(s=>e("button",{key:s,onClick:()=>setRat(s),style:{background:"none",border:"none",cursor:"pointer",padding:3}},ICO.star(34,s<=rat?T.accent:"transparent",s<=rat?T.accent:T.textDim)))
          ),
          e("textarea",{value:notes,onChange:ev=>setNotes(ev.target.value),placeholder:"Note...",style:{width:"100%",padding:10,borderRadius:10,border:"1px solid "+T.border,background:T.surfaceHi,color:T.text,fontSize:17,fontFamily:"inherit",resize:"vertical",minHeight:56,boxSizing:"border-box"}}),
        ),
        e("button",{onClick:save,style:S.bt()},e("span",{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:8}},ICO.check(18)," Salva")),
        e("button",{onClick:home,style:{...S.bt(T.surface,T.textSec),marginTop:8,border:"1px solid "+T.border}},"Salta"),
      ),
    );

    return e("div",{style:{...S.pg,display:"flex",flexDirection:"column",height:"100dvh"}},
      e("div",{style:{...S.hd,justifyContent:"space-between"}},
        e("button",{onClick:()=>{setRun(false);setView("recipe");},style:{...S.ibBack,background:T.red+"18"}},ICO.x(24,T.red)),
        e("span",{style:{fontSize:15,fontWeight:600,color:T.textSec,flex:1,textAlign:"center",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}},sc.name),
        e("div",{style:{fontSize:22,fontWeight:800,color:T.accent,fontVariantNumeric:"tabular-nums"}},fmt(te)),
      ),
      e("div",{style:{flex:1,display:"flex",flexDirection:"column",padding:18,overflow:"auto"}},
        e("div",{style:{background:T.surfaceHi,borderRadius:18,padding:20,marginBottom:12,border:"2px solid "+T.accent,textAlign:"center"}},
          e("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}},
            e("span",{style:S.pl},isDesc?"Rituale":("Step "+(cs+1)+"/"+sc.steps.length)),
            e("span",{style:{fontSize:42,fontWeight:800,fontVariantNumeric:"tabular-nums",color:isDesc?"#8B6914":pr>0.8?T.accentLight:T.text}},isDesc?"‚Äî":fmt(Math.max(0,dur-se))),
          ),
          !isDesc&&e("div",{style:{height:7,borderRadius:4,background:T.border,marginBottom:16,overflow:"hidden"}},
            e("div",{style:{height:"100%",borderRadius:3,background:pr>0.8?T.accentLight:T.accent,width:(pr*100)+"%",transition:"width 0.3s linear"}}),
          ),
          e("p",{style:{fontSize:TF.md(),lineHeight:1.6,fontWeight:600,marginBottom:14}},st?.text),
          st?.waterAdd>0&&e("div",{style:{display:"flex",justifyContent:"center",gap:14,marginTop:4}},
            e("div",{style:{padding:"5px 12px",borderRadius:10,background:T.surface}},e("div",{style:{fontSize:22,fontWeight:800,color:T.accent}},"+"+st.waterAdd+"ml"),e("div",{style:{fontSize:12,color:T.textDim}},"versa")),
            e("div",{style:{padding:"5px 12px",borderRadius:10,background:T.surface}},e("div",{style:{fontSize:22,fontWeight:800,color:T.accentLight}},cW+"ml"),e("div",{style:{fontSize:12,color:T.textDim}},"totale")),
          ),
        ),
        e("div",{style:{flex:1}},sc.steps.map((s,i)=>{const d=i<cs,a=i===cs;return e("div",{key:i,style:{display:"flex",gap:8,marginBottom:5,opacity:d?0.35:a?1:0.45}},
          e("div",{style:{width:24,height:24,borderRadius:12,background:d?T.green:a?T.accent:T.surfaceHi,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}},
            d?ICO.check(11):e("span",{style:{fontSize:11,fontWeight:700,color:a?"#1A1410":T.textDim}},i+1)),
          e("div",{style:{fontSize:16,color:a?T.text:T.textSec,lineHeight:1.4,paddingTop:1}},s.text.length>60?s.text.substring(0,57)+"...":s.text),
        );})),
      ),
      e("div",{style:{padding:"10px 18px 24px",display:"flex",gap:10,background:T.bg,borderTop:"1px solid "+T.border}},
        isDesc?e("button",{onClick:skip,style:{...S.bt(T.accent,"#1A1410"),flex:1,display:"flex",alignItems:"center",justifyContent:"center",gap:8}},ICO.skip(18)," Avanti"):e("button",{onClick:()=>setRun(!run),style:{...S.bt(run?T.surfaceHi:T.accent,run?T.text:"#1A1410"),flex:1,display:"flex",alignItems:"center",justifyContent:"center",gap:8}},
          run?[ICO.pause(18,run?T.text:"#1A1410")," Pausa"]:[ICO.play(18)," Riprendi"]),
        !isDesc&&e("button",{onClick:skip,style:{...S.ibSm,width:48,height:48,borderRadius:14}},ICO.skip(18)),
      ),
    );
  }

  // HISTORY
  if(view==="history")return e("div",{style:S.pg},
    e("div",{style:S.hd},e("button",{onClick:home,style:S.ibBack},ICO.back(22,"#C0392B"),e("span",{style:{fontSize:13,fontWeight:700}},"Indietro")),e("span",{style:S.ht},"I tuoi Brew")),
    e("div",{style:{padding:20}},
      hist.length===0?e("div",{style:{textAlign:"center",padding:40,color:T.textSec}},"Nessun brew salvato."):
      [
        ...hist.map(h=>{const mo=mObj(h.method);return e("div",{key:h.id,style:{...S.cd,cursor:"default"}},
          e("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"start"}},
            e("div",{style:{flex:1}},
              e("div",{style:{display:"flex",alignItems:"center",gap:6,marginBottom:3}},mo&&Ic(mo.icon,22),e("span",{style:{fontWeight:700,fontSize:17}},h.recipeName)),
              e("div",{style:{fontSize:14,color:T.textSec}},h.date+" ¬∑ "+h.time),
            ),
            e("div",{style:{display:"flex",gap:2}},[1,2,3,4,5].map(s=>ICO.star(22,s<=h.rating?T.accent:"transparent",s<=h.rating?T.accent:T.textDim))),
          ),
          e("div",{style:{display:"flex",gap:8,marginTop:8,fontSize:13,color:T.textDim}},h.coffee+"g ¬∑ "+h.water+"ml ¬∑ "+h.clicks+" click"+(h.temperature>0?" ¬∑ "+h.temperature+"¬∞C":"")),
          h.notes&&e("div",{style:{marginTop:6,fontSize:14,color:T.textSec,fontStyle:"italic"}},'"'+h.notes+'"'),
        );}),
        e("button",{key:"del",onClick:()=>sH([]),style:{...S.bt(T.surface,T.red),marginTop:8,border:"1px solid "+T.border,display:"flex",alignItems:"center",justifyContent:"center",gap:8}},ICO.trash(16)," Cancella storico"),
      ],
    ),
  );

  // ADD/EDIT CUSTOM RECIPE
  if(view==="addrecipe"||view==="editrecipe"){
    const isEdit=view==="editrecipe";

    const inp=(lb,val,set,ph,tp)=>e("div",{key:lb,style:{marginBottom:12}},
      e("label",{style:{fontSize:13,color:T.textSec,fontWeight:600,display:"block",marginBottom:4}},lb),
      e("input",{value:val,onChange:ev=>set(ev.target.value),placeholder:ph,type:tp||"text",
        style:{width:"100%",padding:"12px 14px",borderRadius:12,border:"1px solid "+T.border,background:T.surface,color:T.text,fontSize:16,outline:"none",boxSizing:"border-box"}}));
    const addStep=()=>setFst([...fst,{text:"",waterAdd:0,duration:30}]);
    const rmStep=i=>setFst(fst.filter((_,j)=>j!==i));
    const upStep=(i,k,v)=>setFst(fst.map((s,j)=>j===i?{...s,[k]:v}:s));
    const saveR=()=>{
      if(!fn.trim())return;
      const nr={id:isEdit&&selR?selR.id:"custom-"+Date.now(),method:fm,name:fn.trim(),author:fa.trim()||"Personale",description:fd.trim(),
        baseCoffee:parseInt(fc2)||15,baseWater:parseInt(fw2)||250,temperature:parseInt(ft2)||93,clicks:parseInt(fk2)||24,microns:parseInt(fmu2)||720,
        grindDesc:fgd2||"Medium",beans:[],steps:fst.filter(s=>s.text.trim()).map(s=>({text:s.text.trim(),waterAdd:parseInt(s.waterAdd)||0,duration:parseInt(s.duration)||30})),custom:true};
      if(isEdit){sC(customR.map(r=>r.id===nr.id?nr:r));}else{sC([...customR,nr]);}
      home();
    };
    const delR=()=>{sC(customR.filter(r=>r.id!==selR?.id));home();};
    return e("div",{style:S.pg},
      e("div",{style:S.hd},e("button",{onClick:home,style:S.ibBack},ICO.back(22,"#C0392B"),e("span",{style:{fontSize:13,fontWeight:700}},"Indietro")),e("span",{style:S.ht},isEdit?"Modifica Ricetta":"Nuova Ricetta")),
      e("div",{style:{padding:20}},
        inp("Nome ricetta *",fn,setFn,"Es: My V60 Morning"),
        inp("Autore",fa,setFa,"Es: Il tuo nome"),
        inp("Descrizione",fd,setFd,"Note sulla ricetta"),
        e("div",{style:{marginBottom:12}},
          e("label",{style:{fontSize:13,color:T.textSec,fontWeight:600,display:"block",marginBottom:4}},"Metodo"),
          e("select",{value:fm,onChange:ev=>setFm(ev.target.value),
            style:{width:"100%",padding:"12px 14px",borderRadius:12,border:"1px solid "+T.border,background:T.surface,color:T.text,fontSize:16}},
            METHODS.map(m=>e("option",{key:m.id,value:m.id},m.name)))),
        e("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}},
          inp("Caff√® (g)",fc2,setFc2,"15","number"),
          inp("Acqua (ml)",fw2,setFw2,"250","number"),
          inp("Temp (¬∞C)",ft2,setFt2,"93","number"),
          inp("Click C40",fk2,setFk2,"24","number"),
        ),
        e("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}},
          inp("Micron",fmu2,setFmu2,"720","number"),
          inp("Descrizione grind",fgd2,setFgd2,"Medium-fine"),
        ),
        e("div",{style:{fontSize:14,color:T.accent,fontWeight:700,letterSpacing:1,textTransform:"uppercase",marginTop:16,marginBottom:10}},"Step"),
        fst.map((s,i)=>e("div",{key:i,style:{background:T.surface,borderRadius:14,padding:14,marginBottom:10,border:"1px solid "+T.border}},
          e("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}},
            e("span",{style:{fontSize:14,fontWeight:700,color:T.accent}},"Step "+(i+1)),
            fst.length>1&&e("button",{onClick:()=>rmStep(i),style:{...S.ibSm,width:28,height:28,borderRadius:14}},ICO.x(12))),
          e("input",{value:s.text,onChange:ev=>upStep(i,"text",ev.target.value),placeholder:"Descrizione step",
            style:{width:"100%",padding:"10px 12px",borderRadius:10,border:"1px solid "+T.border,background:T.bg,color:T.text,fontSize:15,marginBottom:8,boxSizing:"border-box"}}),
          e("div",{style:{display:"flex",gap:8}},
            e("div",{style:{flex:1}},e("label",{style:{fontSize:11,color:T.textDim}},"Acqua (ml)"),
              e("input",{value:s.waterAdd,onChange:ev=>upStep(i,"waterAdd",ev.target.value),type:"number",
                style:{width:"100%",padding:"8px 10px",borderRadius:8,border:"1px solid "+T.border,background:T.bg,color:T.text,fontSize:14,boxSizing:"border-box"}})),
            e("div",{style:{flex:1}},e("label",{style:{fontSize:11,color:T.textDim}},"Durata (sec)"),
              e("input",{value:s.duration,onChange:ev=>upStep(i,"duration",ev.target.value),type:"number",
                style:{width:"100%",padding:"8px 10px",borderRadius:8,border:"1px solid "+T.border,background:T.bg,color:T.text,fontSize:14,boxSizing:"border-box"}})),
          ),
        )),
        e("button",{onClick:addStep,style:{...S.bt(T.surface,T.accent),width:"100%",marginBottom:16,border:"1px dashed "+T.accent}},"+  Aggiungi Step"),
        e("button",{onClick:saveR,style:{...S.bt("#2D7D46","#FFF"),width:"100%",marginBottom:10,fontSize:18,fontWeight:800}},isEdit?"\u2713 Salva Modifiche":"\u2713 Salva Ricetta"),
        isEdit&&e("button",{onClick:delR,style:{...S.bt(T.surface,T.red),width:"100%",border:"1px solid "+T.border,display:"flex",alignItems:"center",justifyContent:"center",gap:8}},ICO.trash(16)," Elimina Ricetta"),
      ),
    );
  }

  // GRIND GUIDE
  if(view==="grind")return e("div",{style:S.pg},
    e("div",{style:S.hd},e("button",{onClick:home,style:S.ibBack},ICO.back(22,"#C0392B"),e("span",{style:{fontSize:13,fontWeight:700}},"Indietro")),e("span",{style:S.ht},"Guida Granulometria")),
    e("div",{style:{padding:20}},
      e("div",{style:{...S.cd,cursor:"default"}},
        e("div",{style:{fontSize:14,color:T.accent,fontWeight:700,letterSpacing:1,textTransform:"uppercase",marginBottom:12}},"Riferimenti macinini"),
        e("table",{style:{width:"100%",tableLayout:"fixed",borderCollapse:"collapse",fontSize:14}},
          e("thead",null,e("tr",null,
            e("th",{style:{textAlign:"left",padding:"8px 4px",borderBottom:"1px solid "+T.border,color:T.textSec,fontSize:12,width:"38%"}},"Macinino"),
            e("th",{style:{textAlign:"center",padding:"8px 4px",borderBottom:"1px solid "+T.border,color:T.textSec,fontSize:12,width:"31%"}},"Medio-Fine"),
            e("th",{style:{textAlign:"center",padding:"8px 4px",borderBottom:"1px solid "+T.border,color:T.textSec,fontSize:12,width:"31%"}},"Grosso"),
          )),
          e("tbody",null,
            [["Comandante C40","22-25 click","28-32 click"],["Baratza Encore","12-15","20-22"],["Timemore C2/C3","16-18 click","22-24 click"],["Wilfa Svart","AP‚ÜíFiltro","Filtro‚ÜíFP"],["1Zpresso JX","2.4-2.8","3.2-3.6"]].map((r,i)=>
              e("tr",{key:i},r.map((c,j)=>e("td",{key:j,style:{padding:"10px 4px",borderBottom:"1px solid "+T.border,textAlign:j===0?"left":"center",color:j===0?T.text:T.accentLight,fontWeight:j===0?600:700,wordBreak:"break-word"}},c)))
            )
          ),
        ),
      ),
      e("div",{style:{...S.cd,cursor:"default"}},
        e("div",{style:{fontSize:14,color:T.accent,fontWeight:700,letterSpacing:1,textTransform:"uppercase",marginBottom:14}},"Diagnostica"),
        [
          ["\u26A0\uFE0F Troppo fine","V60: >3:30 ¬∑ AP: >2:30 ¬∑ Amaro, astringente","Aumenta 2-3 click"],
          ["\u26A0\uFE0F Troppo grossa","V60: <2:30 ¬∑ AP: <1:15 ¬∑ Acido, vuoto","Riduci 2-3 click"],
          ["\u2705 Giusta","V60: 2:45-3:30 ¬∑ AP: 1:30-2:15 ¬∑ Dolce, pulita","Mantieni"],
        ].map((d,i)=>e("div",{key:i,style:{marginBottom:12,padding:12,borderRadius:12,background:T.surfaceHi}},
          e("div",{style:{fontWeight:700,fontSize:16,marginBottom:4}},d[0]),
          e("div",{style:{fontSize:15,color:T.textSec,lineHeight:1.5}},d[1]),
          e("div",{style:{fontSize:14,color:T.accent,fontWeight:600,marginTop:4}},d[2]),
        )),
      ),
      e("div",{style:{...S.cd,cursor:"default"}},
        e("div",{style:{fontSize:14,color:T.accent,fontWeight:700,letterSpacing:1,textTransform:"uppercase",marginBottom:10}},"Formula rapida"),
        e("div",{style:{fontSize:16,color:T.textSec,lineHeight:1.7}},
          "Comandante C40: ~30¬µm per click.",
          e("br"),
          "22 click ‚âà 660¬µm (V60 Hoffmann)",
          e("br"),
          "30 click ‚âà 900¬µm (4:6 Kasuya)",
          e("br"),
          "15 click ‚âà 450¬µm (AeroPress fine)",
        ),
      ),
    ),
  );

  return e("div",{style:S.pg},e("div",{style:{padding:40,textAlign:"center"}},e("button",{onClick:home,style:S.bt()},"Home")));
}

ReactDOM.createRoot(document.getElementById("root")).render(e(App));
</script>
<script>
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('sw.js').catch(()=>{});
  });
}
</script>
</body>
</html>
